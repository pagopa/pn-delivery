AWSTemplateFormatVersion: 2010-09-09
Description: "Example microservice deploy"

Transform:
  - UpdateDeploymentTransform

Parameters:
  ProjectName:
    Type: String
    Description:
      "Usually pn can be pnXYZ where XYZ are the feature number, useful to create
      experimental environments without crash official development environment"

  ApiDnsName:
    Type: String
    Description: "The DNS name used for B2B rest API."

  WebApiDnsName:
    Type: String
    Description: "The DNS name used for WEB rest API."

  IoApiDnsName:
    Type: String
    Description: "The DNS name used for IO rest API."

  DestApiDnsName:
    Type: String
    Description: 'The DNS name used for B2B PG rest API.'

  CorsAllowedDomains:
    Type: String
    Description: "Comma separated list of domains allowed to make cross origin request"

  ContainerImageUri:
    Type: String
    Description: "Exact container image URI with full repository and image digest"

  MicroserviceNumber:
    Type: Number
    Description: "Disambiguation useful for load balancer rules"

  TemplateBucketBaseUrl:
    Type: String
    Description: "The S3 bucket from which to fetch the templates used by this stack."

  DeliveryPushInputsQueueName:
    Type: String
    Description: "Queue to pull for inputs event"

  SandboxSafeStorageBaseUrl:
    Type: String
    Description: "Url to the SafeStorage microservice"

  NotificationsDynamoTableName:
    Type: String
    Description: "Notifications Dynamo table name"

  NotificationsDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing notifications"

  NotificationsDynamoTableStreamArn:
    Type: String
    Description: "ARN of dynamodb table containing notifications streams"

  NotificationsCostDynamoTableName:
    Type: String
    Description: "Notifications Cost Dynamo table name"

  NotificationsCostDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing notifications cost"

  NotificationsQRDynamoTableName:
    Type: String
    Description: "Notifications QR Dynamo table name"

  NotificationsQRDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing notifications QR"

  NotificationsMetadataDynamoTableName:
    Type: String
    Description: "NotificationsMetadata Dynamo table name"

  NotificationsMetadataDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing notifications metadata"

  NotificationDelegationMetadataDynamoTableName:
    Type: String
    Description: Name of dynamodb table containing delegated notifications metadata

  NotificationDelegationMetadataDynamoTableArn:
    Type: String
    Description: ARN of dynamodb table containing delegated notifications metadata

  TaxonomyCodeDynamoTableName:
    Type: String
    Description: "TaxonomyCode Dynamo table name"

  TaxonomyCodeDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing taxonomy codes"

  PaNotificationLimitDynamoTableName:
    Type: String
    Description: "PaNotificationLimit Dynamo table name"

  PaNotificationLimitDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing pa notification limits"

  CheckTaxonomyCodeEnabled:
    Type: String
    Description: "Flag to enable taxonomy code validation"
    AllowedValues: [ true, false ]
    Default: false

  ECSClusterName:
    Type: String
    Description: "The name of the ECS cluster where the microservice is going to be deployed"

  SubnetsIds:
    Type: CommaDelimitedList
    Description: "subnets ids comma separated list. Where to deploy the microservice"

  VpcEgressSubnetsIds:
    Type: String
    Description: subnets where to install PN-CORE

  VpcId:
    Type: String
    Description: "VpcId where the microservice is going to be deployed"

  EcsDefaultSecurityGroup:
    Type: String
    Description: "Default security group required by infrastructure"

  ApplicationLoadBalancerListenerArn:
    Type: String
    Description: "Load balancer listener where HTTP endpoints is going to be registered"

  ApplicationLoadBalancerDomain:
    Type: String
    Description: "Base URL of the load balancer where the service is going to be reachable"

  NetworkLoadBalancerLink:
    Type: String
    Description: "network load balancer link for API-GW"

  AlarmSNSTopicArn:
    Type: String
    Description: ARN of alarm topic


  IsMvpDefaultValue:
    Type: String
    Description: "default value to return if paTaxId not present in parameter store"
    AllowedValues: [true, false]

  IsLollipopActive:
    Type: String
    Description: "lollipop authorization activation flag"
    AllowedValues: [true, false]
    Default: false

  IsSendActiveDefaultValue:
    Type: String
    Description: "default value to return if paTaxId not present in parameter store"
    AllowedValues: [true, false]

  LollipopExpectedLcOriginalUrl:
    Type: String
    Description: "expected lollipop consumer original url"

  LollipopEnableConsumerLogging:
    Type: String
    Description: "enable lollipop consumer logging"

  MaxAttachmentsCount:
    Type: String
    Description: "Max number of attachments allowed for a notification"

  MaxRecipientsCount:
    Type: String
    Description: "Max number of recipients allowed for a notification"

  MaxDocumentsAvailableDays:
    Type: String
    Description: "maximum number of days in which documents are available from refinement"

  PhysicalAddressValidationValue:
    Type: String
    Description: "Flag to activate the physical address validation. Default: false"
    Default: false
    AllowedValues: [true, false]

  DenominationLength:
    Type: Number
    Description: "denomination length"
    Default: 44

  DenominationValidationTypeValue:
    Type: String
    Description: "Flag to activate the denomination validation. Default: NONE"
    Default: "NONE"
    AllowedValues: [NONE, REGEX, ISO_LATIN_1]

  DenominationValidationRegexValue:
    Type: String
    Description: "regex for denomination validation."

  DenominationValidationExcludedCharacter:
    Type: String
    Description: "string composed of invalid characters for denomination, or NONE if not used. Default: NONE"
    Default: "NONE"

  PhysicalAddressValidationCharsValue:
    Type: String
    Description: "Physical address validation. Allowed Characters"
    Default: "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ./ '-"

  PhysicalAddressValidationLength:
    Type: Number
    Description: "Physical address validation length."
    Default: 44

  LogsKinesisSourceStreamArn:
    Type: String
    Description: "Kinesis stream that receive logs"

  PnNotificationRefusedQueueName:
    Type: String
    Description: "Queue to pull for refused notifications"

  PnNotificationRefusedQueueARN:
    Type: String
    Description: "Queue ARN to pull for refused notifications"

  NotificationRefusedVerificationDynamoTableName:
    Type: String
    Description: "NotificationRefusedVerification Dynamo table name"

  NotificationRefusedVerificationDynamoTableArn:
    Type: String
    Description: "ARN of dynamodb table containing notification refused verification"

  DeliveryPushInputsQueueARN:
    Type: String
    Description: "Target queue ARN for insert trigger"

  DeliveryPushInputsQueueURL:
    Type: String
    Description: "Target queue URL for insert trigger"

  PnDeliveryAsseverationQueueName:
    Type: String
    Description: "Target queue name for insert asseveration"

  PnDeliveryAsseverationQueueARN:
    Type: String
    Description: "Target queue ARN for insert asseveration"

  PnDeliveryAsseverationDLQAlarmARN:
    Type: String
    Description: "DLQ Alarm ARN for insert asseveration"

  PnDeliveryAsseverationAgeAlarmARN:
    Type: String
    Description: "Age Alarm ARN for insert asseveration"

  PnDeliveryAsseverationLambdaEventSourceMappingBatchSize:
    Type: String
    Default: "100"
    Description: "BatchSize asseveration event source mapping"

  PnDeliveryAsseverationEventSourceMappingMaximumBatchingWindowInSeconds:
    Type: String
    Default: "30"
    Description: "MaximumBatchingWindow asseveration event source mapping"

  PnDeliveryAsseverationLambdaTimeout:
    Type: Number
    Default: 900
    Description: "Timeout in seconds of the asseveration lambda"

  PnDeliveryAsseverationLambdaMemory:
    Type: Number
    Default: 128
    MinValue: 128
    MaxValue: 10240
    Description: "Memory in MB of the asseveration lambda"

  LogsBucketName:
    Type: String
    Description: "Logs bucket name"

  PnDeliveryInsertTriggerDLQARN:
    Type: String
    Description: "DLQ ARN for insert trigger"

  PnDeliveryInsertTriggerDLQAlarmARN:
    Type: String
    Description: "DLQ Alarm ARN for insert trigger"

  PnDeliveryInsertTriggerLambdaEventSourceMappingBatchSize:
    Type: String
    Description: "BatchSize stream mapping"

  PnDeliveryInsertTriggerLambdaEventSourceMappingMaximumBatchingWindowInSeconds:
    Type: String
    Description: "BatchWindow stream mapping"

  PnDeliveryInsertTriggerLambdaEventSourceMappingMaximumRetryAttempts:
    Type: String
    Description: "MaxRetry stream mapping"

  AlbSecurityGroup:
    Type: String
    Description: "Application load balancer security group"

  # Log group parameters
  EcsLogGroup:
    Type: String
    Description: "Ecs log group name"

  PnDeliveryAsseverationLambdaName:
    Type: String
    Description: "PnDeliveryAsseverationLambdaLogGroup"

  PnDeliveryInsertTriggerLambdaName:
    Type: String
    Description: "PnDeliveryInsertTriggerLambdaName"

  # OpenApi Bucket params
  MicroserviceBucketName:
    Type: String
    Default: ""
    Description: "Name of the bucket where the microservice files are copied during deploy"

  MicroserviceBucketBaseKey:
    Type: String
    Default: ""
    Description: "Base key of the microservice in the s3 bucket"

  # Heath Check parameters
  HealthCheckInterval:
    Description: Seconds between two health check
    Type: Number
    Default: 60

  HealthCheckTimeout:
    Description: health check timeout seconds
    Type: Number
    Default: 5

  HealthyThresholdCount:
    Description: |
      The number of consecutive health checks successes required before considering 
      an unhealthy target healthy.
    Type: Number
    Default: 5

  UnhealthyThresholdCount:
    Description: |
      The number of consecutive health check failures required before considering a target unhealthy.
    Type: Number
    Default: 2

  # Instance parameters
  # 256 (.25 vCPU) - Available memory values: 0.5GB, 1GB, 2GB
  # 512 (.5 vCPU) - Available memory values: 1GB, 2GB, 3GB, 4GB
  # 1024 (1 vCPU) - Available memory values: 2GB, 3GB, 4GB, 5GB, 6GB, 7GB, 8GB
  # 2048 (2 vCPU) - Available memory values: Between 4GB and 16GB in 1GB increments
  # 4096 (4 vCPU) - Available memory values: Between 8GB and 30GB in 1GB increments
  CpuValue:
    Type: Number
    Default: 1024
    Description: Fargate virtual CPU quantity 1024 equals one vCPU

  # 0.5GB, 1GB, 2GB - Available cpu values: 256 (.25 vCPU)
  # 1GB, 2GB, 3GB, 4GB - Available cpu values: 512 (.5 vCPU)
  # 2GB, 3GB, 4GB, 5GB, 6GB, 7GB, 8GB - Available cpu values: 1024 (1 vCPU)
  # Between 4GB and 16GB in 1GB increments - Available cpu values: 2048 (2 vCPU)
  # Between 8GB and 30GB in 1GB increments - Available cpu values: 4096 (4 vCPU)
  MemoryAmount:
    Type: String
    Default: 2GB
    Description: memory amount reserved to the task pod.
    AllowedValues: [2GB, 4GB, 6GB, 8GB]

  EnableTaxIdExternalValidation:
    Type: String
    Default: false
    Description: "Boolean that enables the external validation on AdE of tax id"
    AllowedValues:
      - true
      - false

  SkipCheckTaxIdInBlackList:
    Type: String
    Default: true
    Description: "Boolean that enables the blacklist check of tax id"
    AllowedValues:
      - true
      - false

  # Autoscaling parameters
  AutoscalingCheckPeriod:
    Default: 60
    Type: Number
    Description: minimum autoscaling number of tasks\

  AutoscalingDataPointN:
    Default: 1
    Type: Number
    Description: activate when N datapoint on M

  AutoscalingDataPointM:
    Default: 1
    Type: Number
    Description: activate when N datapoint on M

  AutoscalingThreshold:
    Default: 70
    Type: String

  MinTasksNumber:
    Default: 1
    Type: Number
    Description: minimum autoscaling number of tasks

  MaxTasksNumber:
    Default: 6
    Type: Number
    Description: maximum autoscaling number of tasks

  Mandate2DeliveryQueueName:
    Type: String
    Description: "The name of the SQS queue used to communicate with pn-mandate module."

  Mandate2DeliveryQueueARN:
    Type: String
    Description: "Identify the resource that the policy applies to."

  LogAlarmStrategy:
    Type: String
    Default: "FATAL"

  IOBackendCidrs:
    Type: String
    Default: ""

  VersioningV1V2GetNotificationLambdaName:
    Type: String
    Description: "VersioningV1V2GetNotificationName"

  VersioningV1V2GetNotificationLambdaProvisionedConcurrency:
    Type: Number
    Description: "VersioningV1V2GetNotificationProvisionedConcurrency"
    Default: 1

  EnhancedWebSecurityEnabled:
    Type: String
    Default: false
    Description: Enable additional WAF Web rules
    AllowedValues:
      - true
      - false

  VersioningV1V21SendNewNotificationLambdaName:
    Type: String
    Description: "VersioningV1V21SendNewNotificationName"

  VersioningV1V21SendNewNotificationLambdaProvisionedConcurrency:
    Type: Number
    Description: "VersioningV1V21SendNewNotificationProvisionedConcurrency"
    Default: 1

  VersioningV1V21GetNotificationRequestStatusLambdaName:
    Type: String
    Description: "VersioningV1V21GetNotificationRequestStatusName"

  VersioningV1V21GetNotificationRequestStatusLambdaProvisionedConcurrency:
    Type: Number
    Description: "VersioningV1V21GetNotificationRequestStatusProvisionedConcurrency"
    Default: 1

  VersioningV1V23GetNotificationPriceLambdaName:
    Type: String
    Description: "VersioningV1V23GetNotificationPriceName"

  VersioningV1V23GetNotificationPriceLambdaProvisionedConcurrency:
    Type: Number
    Description: "VersioningV1V23GetNotificationPriceProvisionedConcurrency"
    Default: 1

  MetadataStatusUpdaterLambdaName:
    Type: String
    Description: "MetadataStatusUpdaterLambdaName"

  CdcKinesisSourceStreamArn:
    Type: String
    Description: 'Where to send CDC'

  CdcKinesisSourceStreamKeyArn:
    Description: "Kinesis source CDC stream crypto key ARN"
    Type: String

  PnDeliveryMetadataStatusDLQARN:
   Type: String
   Description: "DLQ ARN for metadata status updater"

  PnDeliveryMetadataStatusDLQAlarmARN:
    Type: String
    Description: "DLQ Alarm ARN for metadata status updater"

  PnDeliveryMetadataStatusLambdaBatchSize:
    Type: String
    Description: "BatchSize metadata status updater"

  PnDeliveryMetadataStatusLambdaMaxRetryAttempts:
    Type: Number
    Description: "MaxRetryAttempts for metadata status updater Lambda"
    Default: 3

  PnDeliveryMetadataStatusUpdaterLambdaMaximumBatchingWindowInSeconds:
    Type: String
    Description: "MaximumBatchingWindow metadata status updater"

  B2bWafLimit:
    Default: 600000
    Type: Number
    Description: b2b waf limit

  WebWafLimit:
    Default: 600000
    Type: Number
    Description: web waf limit

  # EFS parameters
  FargateEFSFileSystemID:
    Type: String
    Description: "EFS Filesystem"

  MountEfs:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  # Logging parameters
  WireTapLogActivation:
    Type: String
    Default: false
    Description: Activation of wire logs
    AllowedValues:
      - true
      - false

  PnCronAnalyzer:
    Type: String
    Default: "-"
    Description: Cron for which you send the metric to CloudWatch

  AttemptTimeoutSec:
    Type: Number
    Description: 'Timeout in seconds for each retry attempt for each idempotent versioning lambda'
    Default: 7

  NumRetry:
    Type: Number
    Description: 'Number of retries for each idempotent versioning lambda'
    Default: 3

  LollipopIdpRestConfigReadTimeout:
    Type: String
    Default: "8000ms"
    Description: Read timeout for Lollipop Idp endpoint in duration format

  LollipopIdpRestConfigConnectionTimeout:
    Type: String
    Default: "3000ms"
    Description: Connection timeout for Lollipop Idp endpoint in duration format

  LollipopAssertionRestConfigReadTimeout:
    Type: String
    Default: "8000ms"
    Description: Read timeout for Lollipop Assertion endpoint in duration format

  LollipopAssertionRestConfigConnectionTimeout:
    Type: String
    Default: "3000ms"
    Description: Connection timeout for Lollipop Assertion endpoint in duration format

  EnableDeceasedWorkflow:
    Type: String
    Description: 'Enables the workflow for the deceased recipient'
    Default: false

  LambdaMemorySize:
    Default: 512
    Type: Number
    Description: MemorySize Lambda Versioning

  # NotificationRefusedDispatcherLambda parameters
  NotificationRefusedDispatcherLambdaName:
    Type: String
    Description: "Lambda name for NotificationRefusedDispatcher"

  PnNotificationRefusedQueueURL:
    Type: String
    Description: "Queue URL for NotificationRefusedDispatcher"

  PnNotificationRefusedDispatcherDLQARN:
    Type: String
    Description: "DLQ ARN for NotificationRefusedDispatcher"

  NotificationRefusedDispatcherLambdaBatchSize:
    Type: String
    Description: "BatchSize for NotificationRefusedDispatcher"

  NotificationRefusedDispatcherLambdaMaximumBatchingWindowInSeconds:
    Type: String
    Description: "MaximumBatchingWindow for NotificationRefusedDispatcher"

  PaLimitCorrectionLambdaName:
    Type: String
    Description: "PaLimitCorrectionLambdaName"

  PaLimitCorrectionLambdaTimeout:
    Type: Number
    Description: "Timeout in seconds of the pa limit correction lambda"
    Default: 300

  PaLimitCorrectionLambdaMaximumRetryAttempts:
    Type: Number
    Description: "MaximumRetryAttempts for pa limit correction Lambda"
    Default: 1

  PnDeliveryPaLimitCorrectionDLQARN:
    Type: String
    Description: "DLQ ARN for pa limit correction"

  PnDeliveryPaLimitCorrectionDLQAlarmARN:
    Type: String
    Description: "DLQ Alarm ARN for pa limit correction"

  PnDeliveryPaLimitCorrectionLambdaCron:
    Type: String
    Default: '0 12 * * ? *'
    Description: Cron to schedule the Lambda PaLimitCorrection (UTC). Default is every day at 12:00

Conditions:
  SendLogToKinesis: !Not [!Equals [!Ref LogsKinesisSourceStreamArn, ""]]

Resources:
  # PN-Delivery microservice
  DeliveryMicroservice:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/ecs-service.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub "${ProjectName}-delivery"
        CpuValue: !Ref CpuValue
        MemoryAmount: !Ref MemoryAmount
        HealthCheckPath: /actuator/health
        HealthCheckTimeout: !Ref HealthCheckTimeout
        HealthCheckInterval: !Ref HealthCheckInterval
        HealthyThresholdCount: !Ref HealthyThresholdCount
        UnhealthyThresholdCount: !Ref UnhealthyThresholdCount
        AutoscalingStrategy: REST-API
        AutoscalingThreshold: !Ref AutoscalingThreshold
        AutoscalingCheckPeriod: !Ref AutoscalingCheckPeriod
        MinTasksNumber: !Ref MinTasksNumber
        MaxTasksNumber: !Ref MaxTasksNumber
        AutoscalingDataPointN: !Ref AutoscalingDataPointN
        AutoscalingDataPointM: !Ref AutoscalingDataPointM
        EfsFilesystem: !Ref FargateEFSFileSystemID
        MountEfs: !Ref MountEfs
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        ContainerImageURI: !Sub "${ContainerImageUri}"
        ContainerEnvEntry1: !Sub "AWS_REGIONCODE=${AWS::Region}"
        ContainerEnvEntry2: !Sub "PN_DELIVERY_TOPICS_NEWNOTIFICATIONS=${DeliveryPushInputsQueueName}"
        #ContainerEnvEntry3: !Sub 'AWS_BUCKETNAME=${AttachmentsBucketName}'
        ContainerEnvEntry4: "PN_DELIVERY_IUNRETRY=3"
        #ContainerEnvEntry5: !Sub 'SPRING_DATA_CASSANDRA_KEYSPACENAME=${KeyspaceName}'
        #ContainerEnvEntry6: 'SPRING_DATA_CASSANDRA_SSL=true'
        #ContainerEnvEntry7: !Sub 'SPRING_DATA_CASSANDRA_CONTACTPOINTS=cassandra.${AWS::Region}.${AWS::URLSuffix}:9142'
        ContainerEnvEntry8: !Sub "CORS_ALLOWED_DOMAINS=${CorsAllowedDomains}"
        ContainerEnvEntry9: !Sub "PN_DELIVERY_DELIVERYPUSHBASEURL=http://${ApplicationLoadBalancerDomain}:8080"
        ContainerEnvEntry10: !Sub "PN_DELIVERY_NOTIFICATIONDAO_TABLENAME=${NotificationsDynamoTableName}"
        ContainerEnvEntry11: !Sub "PN_DELIVERY_NOTIFICATIONMETADATADAO_TABLENAME=${NotificationsMetadataDynamoTableName}"
        ContainerEnvEntry12: !Sub "PN_DELIVERY_NOTIFICATIONCOSTDAO_TABLENAME=${NotificationsCostDynamoTableName}"
        ContainerEnvEntry13: !Sub "PN_DELIVERY_MANDATEBASEURL=http://${ApplicationLoadBalancerDomain}:8080"
        ContainerEnvEntry14: !Sub "PN_DELIVERY_SAFESTORAGEBASEURL=${SandboxSafeStorageBaseUrl}"
        ContainerEnvEntry15: "PN_DELIVERY_DATAVAULTBASEURL=http://alb.confidential.pn.internal:8080"
        ContainerEnvEntry16: "PN_DELIVERY_SAFESTORAGECXID=pn-delivery"
        ContainerEnvEntry17: !Sub "PN_DELIVERY_EXTERNALREGISTRIESBASEURL=http://${ApplicationLoadBalancerDomain}:8080"
        ContainerEnvEntry18: !Sub "PN_DELIVERY_NOTIFICATIONQRDAO_TABLENAME=${NotificationsQRDynamoTableName}"
        ContainerEnvEntry19: !Sub "PN_DELIVERY_MAXDOCUMENTSAVAILABLEDAYS=${MaxDocumentsAvailableDays}"
        ContainerEnvEntry20: !Sub "PN_COMMONS_FEATURES_ISMVPDEFAULTVALUE=${IsMvpDefaultValue}"
        ContainerEnvEntry21: !Sub "PN_DELIVERY_TOPICS_PAYMENTEVENTS=${DeliveryPushInputsQueueName}"
        ContainerEnvEntry22: !Sub "PN_DELIVERY_SQS_FROM_PN_MANDATE_NAME=${Mandate2DeliveryQueueName}"
        ContainerEnvEntry23: !Sub "PN_DELIVERY_NOTIFICATIONDELEGATIONMETADATADAO_TABLENAME=${NotificationDelegationMetadataDynamoTableName}"
        ContainerEnvEntry24: !Sub "PN_DELIVERY_TOPICS_ASSEVERATIONEVENTS=${PnDeliveryAsseverationQueueName}"
        ContainerEnvEntry25: !Sub "LOLLIPOP_ACTIVE=${IsLollipopActive}"
        ContainerEnvEntry26: !Sub "PN_DELIVERY_MAXRECIPIENTSCOUNT=${MaxRecipientsCount}"
        ContainerEnvEntry27: !Sub "PN_DELIVERY_MAXATTACHMENTSCOUNT=${MaxAttachmentsCount}"
        ContainerEnvEntry28: !Sub "LOLLIPOP_EXPECTED_LC_ORIGINAL_URL=${LollipopExpectedLcOriginalUrl}"
        ContainerEnvEntry29: !Sub "LOLLIPOP_ENABLE_CONSUMER_LOGGING=${LollipopEnableConsumerLogging}"
        ContainerEnvEntry30: !Sub "PN_DELIVERY_FEATURES_ISSENDACTIVEDEFAULTVALUE=${IsSendActiveDefaultValue}"
        ContainerEnvEntry31: !Sub "PN_DELIVERY_PHYSICALADDRESSVALIDATION=${PhysicalAddressValidationValue}"
        ContainerEnvEntry32: !Sub "PN_DELIVERY_PHYSICALADDRESSVALIDATIONPATTERN=${PhysicalAddressValidationCharsValue}"
        ContainerEnvEntry33: !Sub "PN_DELIVERY_PHYSICALADDRESSVALIDATIONLENGTH=${PhysicalAddressValidationLength}"
        ContainerEnvEntry34: !Sub "PN_DELIVERY_DENOMINATIONLENGTH=${DenominationLength}"
        ContainerEnvEntry35: !Sub "PN_DELIVERY_DENOMINATIONVALIDATIONTYPEVALUE=${DenominationValidationTypeValue}"
        ContainerEnvEntry36: !Sub "PN_DELIVERY_DENOMINATIONVALIDATIONREGEXVALUE=${DenominationValidationRegexValue}"
        ContainerEnvEntry37: "PN_DELIVERY_F24CXID=pn-delivery"
        ContainerEnvEntry38: !Sub "PN_DELIVERY_F24BASEURL=http://${ApplicationLoadBalancerDomain}:8080"
        ContainerEnvEntry39: !Sub "PN_CRON_ANALYZER=${PnCronAnalyzer}"
        ContainerEnvEntry40: !Sub "WIRE_TAP_LOG=${WireTapLogActivation}"
        ContainerEnvEntry41: !Sub "PN_DELIVERY_DENOMINATIONVALIDATIONEXCLUDEDCHARACTER=${DenominationValidationExcludedCharacter}"
        ContainerEnvEntry42: !Sub "LOLLIPOP_IDP_REST_CONFIG_READ_TIMEOUT=${LollipopIdpRestConfigReadTimeout}"
        ContainerEnvEntry43: !Sub "LOLLIPOP_IDP_REST_CONFIG_CONNECTION_TIMEOUT=${LollipopIdpRestConfigConnectionTimeout}"
        ContainerEnvEntry44: !Sub "LOLLIPOP_ASSERTION_REST_CONFIG_READ_TIMEOUT=${LollipopAssertionRestConfigReadTimeout}"
        ContainerEnvEntry45: !Sub "LOLLIPOP_ASSERTION_REST_CONFIG_CONNECTION_TIMEOUT=${LollipopAssertionRestConfigConnectionTimeout}"
        ContainerEnvEntry46: !Sub "PN_DELIVERY_TAXONOMYCODEDAO_TABLENAME=${TaxonomyCodeDynamoTableName}"
        ContainerEnvEntry47: !Sub "PN_DELIVERY_CHECK_TAXONOMY_CODE_ENABLED=${CheckTaxonomyCodeEnabled}"
        ContainerEnvEntry48: !Sub "PN_DELIVERY_ENABLETAXIDEXTERNALVALIDATION=${EnableTaxIdExternalValidation}"
        ContainerEnvEntry49: !Sub "PN_DELIVERY_NATIONALREGISTRIESBASEURL=http://${ApplicationLoadBalancerDomain}:8080"
        ContainerEnvEntry50: !Sub "PN_DELIVERY_SKIPCHECKTAXIDINBLACKLIST=${SkipCheckTaxIdInBlackList}"
        ContainerEnvEntry51: !Sub "PN_DELIVERY_ENABLE_DECEASED_WORKFLOW=${EnableDeceasedWorkflow}"
        ContainerEnvEntry52: !Sub "PN_DELIVERY_PANOTIFICATIONLIMITDAO_TABLENAME=${PaNotificationLimitDynamoTableName}"
        ContainerEnvEntry53: !Sub "PN_DELIVERY_NOTIFICATIONREFUSEDVERIFICATIONDAO_TABLENAME=${NotificationRefusedVerificationDynamoTableName}"
        ContainerEnvEntry54: !Sub "SPRING_CLOUD_FUNCTIONROUTER_QUEUES_LIST=${Mandate2DeliveryQueueName},${PnNotificationRefusedQueueName}"

        ContainerSecret1: !Sub "ASSERTION_REST_SUBSCRIPTION_KEY=arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:pn-Delivery-Secrets:AssertionRestSubscriptionKey:AWSCURRENT:"
        MicroServiceSecretPrefix: pn-Delivery-Secrets
        JavaToolOptions: "-Dreactor.netty.ioWorkerCount=120 -XX:MaxMetaspaceSize=512M"
        MappedPaths: "/delivery/*,/delivery-private/*"
        ECSClusterName: !Ref ECSClusterName
        Subnets: !Ref VpcEgressSubnetsIds
        VpcId: !Ref VpcId
        EcsDefaultSecurityGroup: !Ref EcsDefaultSecurityGroup
        LoadBalancerListenerArn: !Ref ApplicationLoadBalancerListenerArn
        LoadbalancerRulePriority: !Ref MicroserviceNumber
        TaskRoleManagedPolicyArn: !Ref DeliveryMicroserviceTaskManagedPolicy
        AlbSecurityGroup: !Ref AlbSecurityGroup
        EcsLogGroup: !Ref EcsLogGroup
        LogAlarmStrategyV1: !Ref LogAlarmStrategy

  # Grant operational rights to PN-Delivery microservice
  DeliveryMicroserviceTaskManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ReceiveMessage
              - sqs:SendMessage
            Resource:
              - !Ref DeliveryPushInputsQueueARN
              - !Ref Mandate2DeliveryQueueARN
              - !Ref PnDeliveryAsseverationQueueARN
              - !Ref PnNotificationRefusedQueueARN
          - Effect: Allow
            Action:
              - "dynamodb:GetItem"
              - "dynamodb:Query"
              - "dynamodb:PutItem"
            Resource:
              - !Sub "${NotificationsDynamoTableArn}"
              - !Sub "${NotificationsMetadataDynamoTableArn}"
              - !Sub "${NotificationsMetadataDynamoTableArn}/*"
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}"
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}/*"
              - !Sub "${NotificationsCostDynamoTableArn}"
              - !Sub "${NotificationsCostDynamoTableArn}/*"
              - !Sub "${NotificationsQRDynamoTableArn}"
              - !Sub "${NotificationsQRDynamoTableArn}/*"
              - !Sub "${TaxonomyCodeDynamoTableArn}"
              - !Sub "${NotificationRefusedVerificationDynamoTableArn}"
              - !Sub "${NotificationRefusedVerificationDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - "dynamodb:BatchWriteItem"
              - "dynamodb:DeleteItem"
            Resource:
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}"
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - "dynamodb:DeleteItem"
            Resource:
              - !Sub "${NotificationsCostDynamoTableArn}"
              - !Sub "${NotificationsCostDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - "dynamodb:GetItem"
              - "dynamodb:UpdateItem"
            Resource:
              - !Sub "${PaNotificationLimitDynamoTableArn}"
              - !Sub "${PaNotificationLimitDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - ssm:GetParameter
              - ssm:GetParameters
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapPaMVP"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapTaxIdWhiteList"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapTaxIdBlackList"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapPaSendActive"

  # Expose PN-Delivery microservice public API with API-GW for B2B usage
  DeliveryMicroservicePublicAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub "${ProjectName}-delivery"
        IntendedUsage: B2B
        DnsName: !Ref ApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: "delivery"
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-B2B-aws.yaml

  DeliveryMicroservicePublicApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub "${ProjectName}-delivery-b2b"
        IntendedUsage: B2B
        APIGatewayARNs: !GetAtt DeliveryMicroservicePublicAPI.Outputs.APIGatewayARN
        ExcludedRule0: CrossSiteScripting_BODY,SizeRestrictions_BODY
        Limit: !Ref B2bWafLimit

  # Expose PN-Delivery microservice public API with API-GW for B2B usage
  DeliveryMicroserviceB2BPGAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub "${ProjectName}-delivery"
        IntendedUsage: B2BPG
        DnsName: !Ref DestApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: "delivery"
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-B2BPG-aws.yaml

  DeliveryMicroserviceB2BPGApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub "${ProjectName}-delivery-b2b-pg"
        IntendedUsage: B2B
        APIGatewayARNs: !GetAtt DeliveryMicroserviceB2BPGAPI.Outputs.APIGatewayARN
        ExcludedRule0: CrossSiteScripting_BODY,SizeRestrictions_BODY
        Limit: !Ref B2bWafLimit

  # Expose PN-Delivery microservice public API with API-GW for WEB usage
  DeliveryMicroservicePublicWebAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub "${ProjectName}-delivery"
        IntendedUsage: WEB
        DnsName: !Ref WebApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: "delivery"
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-WEB-aws.yaml

  DeliveryMicroservicePublicWebApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub "${ProjectName}-delivery-web"
        IntendedUsage: WEB
        APIGatewayARNs: !GetAtt DeliveryMicroservicePublicWebAPI.Outputs.APIGatewayARN
        Limit: !Ref WebWafLimit
        EnhancedWebSecurityEnabled: !Ref EnhancedWebSecurityEnabled

  # Expose PN-Delivery microservice public API with API-GW for IO Backend usage
  DeliveryMicroservicePublicIoAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub "${ProjectName}-delivery"
        IntendedUsage: IO
        DnsName: !Ref IoApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: "delivery"
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-IO-aws.yaml

  DeliveryMicroservicePublicIoApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub "${ProjectName}-delivery-io"
        IntendedUsage: IO
        APIGatewayARNs: !GetAtt DeliveryMicroservicePublicIoAPI.Outputs.APIGatewayARN
        Limit: 0 # disable IP limit based rule
        AllowedCidrs: !Ref IOBackendCidrs

  # Dashboard
  DeliveryMicroserviceCloudWatchDashboard:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/microservice-cloudwatch-dashboard.yaml"
      Parameters:
        DashboardName: !Sub "${ProjectName}-delivery"
        DynamoDBTableNames: !Join
          - ","
          - - !Ref NotificationsDynamoTableName
            - !Ref NotificationsCostDynamoTableName
            - !Ref NotificationsMetadataDynamoTableName
            - !Ref NotificationDelegationMetadataDynamoTableName
            - !Ref NotificationsQRDynamoTableName
            - !Ref TaxonomyCodeDynamoTableName
            - !Ref PaNotificationLimitDynamoTableName
            - !Ref NotificationRefusedVerificationDynamoTableName
        LambdaArns: !Join
          - ","
          - - !GetAtt PnDeliveryInsertTriggerLambdaStack.Outputs.FunctionArn
            - !GetAtt PnDeliveryAsseverationLambda.Arn
            - !GetAtt VersioningV1V2GetNotificationLambda.Arn
            - !GetAtt VersioningV1V21SendNewNotificationLambda.Arn
            - !GetAtt VersioningV1V21GetNotificationRequestStatusLambda.Arn
            - !GetAtt VersioningV1V23GetNotificationPriceLambda.Arn
        RestApiStageArns: !Join
          - ","
          - - !GetAtt DeliveryMicroservicePublicAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryMicroserviceB2BPGAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryMicroservicePublicWebAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryMicroservicePublicIoAPI.Outputs.RestApiStageArn
        RestApiNames: !Join
          - ","
          - - !GetAtt DeliveryMicroservicePublicAPI.Outputs.RestApiName
            - !GetAtt DeliveryMicroserviceB2BPGAPI.Outputs.RestApiName
            - !GetAtt DeliveryMicroservicePublicWebAPI.Outputs.RestApiName
            - !GetAtt DeliveryMicroservicePublicIoAPI.Outputs.RestApiName
        AlarmArns: !Join
          - ","
          - - !GetAtt DeliveryMicroservice.Outputs.FatalLogsMetricAlarmArn
            - !GetAtt DeliveryMicroservicePublicAPI.Outputs.RestApiErrorAlarmArn
            - !GetAtt DeliveryMicroserviceB2BPGAPI.Outputs.RestApiErrorAlarmArn
            - !GetAtt DeliveryMicroservicePublicWebAPI.Outputs.RestApiErrorAlarmArn
            - !GetAtt DeliveryMicroservicePublicIoAPI.Outputs.RestApiErrorAlarmArn
            - !GetAtt DeliveryMicroservicePublicAPI.Outputs.RestApiLatencyAlarmArn
            - !GetAtt DeliveryMicroserviceB2BPGAPI.Outputs.RestApiLatencyAlarmArn
            - !GetAtt DeliveryMicroservicePublicWebAPI.Outputs.RestApiLatencyAlarmArn
            - !GetAtt DeliveryMicroservicePublicIoAPI.Outputs.RestApiLatencyAlarmArn
            - !Ref PnDeliveryInsertTriggerDLQAlarmARN
            - !Ref PnDeliveryAsseverationDLQAlarmARN
            - !GetAtt PnDeliveryAsseverationLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !Ref PnDeliveryAsseverationAgeAlarmARN
            - !GetAtt VersioningV1V2GetNotificationLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt VersioningV1V21SendNewNotificationLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt VersioningV1V21GetNotificationRequestStatusLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt VersioningV1V23GetNotificationPriceLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt MetadataStatusUpdaterLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt PaLimitCorrectionLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !Ref PnDeliveryMetadataStatusDLQAlarmARN
            - !Ref PnDeliveryPaLimitCorrectionDLQAlarmARN
        QueueArns: !Join
          - ","
          - - !Ref Mandate2DeliveryQueueARN
            - !Ref PnDeliveryAsseverationQueueARN
            - !Ref PnNotificationRefusedQueueARN
        LogGroupsNames: !Join
          - ","
          - - !Sub "/aws/ecs/${ProjectName}-delivery"
            - !Sub "/aws/lambda/${PnDeliveryInsertTriggerLambdaName}"
            - !Sub "/aws/lambda/${PnDeliveryAsseverationLambdaName}"
            - !Sub "/aws/lambda/${VersioningV1V2GetNotificationLambdaName}"
            - !Sub "/aws/lambda/${VersioningV1V21SendNewNotificationLambdaName}"
            - !Sub "/aws/lambda/${VersioningV1V21GetNotificationRequestStatusLambdaName}"
            - !Sub "/aws/lambda/${VersioningV1V23GetNotificationPriceLambdaName}"
            - !Sub "/aws/lambda/${MetadataStatusUpdaterLambdaName}"
  # Lambda function role
  
  PnDeliveryInsertTriggerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-PnDeliveryInsertTriggerLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: !Sub ${ProjectName}-PnDeliveryInsertTriggerLambdaRolePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: PutEvents
                Effect: Allow
                Action:
                  - "events:PutEvents"
                Resource: !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/pn-CoreEventBus"
              - Sid: ReceiveDynamoStream
                Effect: Allow
                Action:
                  - "dynamodb:DescribeStream"
                  - "dynamodb:GetRecords"
                  - "dynamodb:GetShardIterator"
                  - "dynamodb:ListStreams"
                Resource:
                  - !Ref NotificationsDynamoTableStreamArn
              - Sid: DLQWrite
                Effect: Allow
                Action:
                  - sqs:ChangeMessageVisibility
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                  - sqs:SendMessage
                Resource:
 #                 - !Ref DeliveryPushInputsQueueARN
                  - !Ref PnDeliveryInsertTriggerDLQARN
              - Sid: CanWriteLogs
                Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"

  PnDeliveryInsertTriggerLambdaLibrariesLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
        - nodejs18.x
      Content:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/insertTrigger_libs.zip"
      Description: NodeJs Libs layer
      LayerName: insertTriggerLambda-libs-layer

  PnDeliveryInsertTriggerLambdaStack:
    Type: AWS::CloudFormation::Stack
    # UpdateReplacePolicy: Retain
    # DeletionPolicy: Delete
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda.yaml"
      Parameters:
        FunctionName: !Ref PnDeliveryInsertTriggerLambdaName
        Runtime: nodejs18.x
        Handler: "index.handler"
        MemorySize: 256
        Timeout: 10
        RoleArn: !GetAtt PnDeliveryInsertTriggerLambdaRole.Arn
        EnvVariables:
          !Sub [
            "EVENT_BUS_ENDPOINT=${arn}",
            {
              arn: !Sub "arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/pn-CoreEventBus",
            },
          ]
        
        Layer1: !Ref PnDeliveryInsertTriggerLambdaLibrariesLayer
        FunctionBucketName: !Ref MicroserviceBucketName
        FunctionBucketKey: !Sub "${MicroserviceBucketBaseKey}/functions_zip/insertTrigger_code.zip"

  PnDeliveryInsertTriggerLambdaEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref NotificationsDynamoTableStreamArn
      StartingPosition: LATEST
      BatchSize: !Sub ${PnDeliveryInsertTriggerLambdaEventSourceMappingBatchSize}
      MaximumBatchingWindowInSeconds: !Sub ${PnDeliveryInsertTriggerLambdaEventSourceMappingMaximumBatchingWindowInSeconds}
      MaximumRetryAttempts: !Sub ${PnDeliveryInsertTriggerLambdaEventSourceMappingMaximumRetryAttempts}
      FunctionName:
        !GetAtt PnDeliveryInsertTriggerLambdaStack.Outputs.FunctionArn
        # Add an OnFailure destination on the event source mapping
      DestinationConfig:
        OnFailure:
          Destination: !Ref PnDeliveryInsertTriggerDLQARN

  
  PnDeliveryInsertTriggerLambdaLogGrout:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${PnDeliveryInsertTriggerLambdaName}"
      RetentionInDays: 14

  PnDeliveryInsertTriggerLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref PnDeliveryInsertTriggerLambdaName
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn

  

  # Asseveration Lambda function role
  PnDeliveryAsseverationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-PnDeliveryAsseverationLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      # ManagedPolicyArns:
      #   - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy
      Policies:
        - PolicyName: !Sub ${ProjectName}-PnDeliveryAsseverationLambdaRolePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: Dequeue
                Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility #non utilizzata nella policy di esempio
                  - sqs:GetQueueUrl #utilizzata nella policy di esempio
                Resource:
                  - !Ref PnDeliveryAsseverationQueueARN
              - Sid: WriteOnS3
                Effect: Allow
                Action:
                  - s3:PutObject
                Resource:
                  - !Sub "arn:aws:s3:::${LogsBucketName}/flussi/pad26_asseverazione/*"
              - Sid: EncryptS3Data
                Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:GenerateDataKey
                Resource:
                  - !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
                  - !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/*
              - Sid: CanWriteLogs
                Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"

  PnDeliveryAsseverationLambdaEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref PnDeliveryAsseverationQueueARN
      BatchSize: !Sub ${PnDeliveryAsseverationLambdaEventSourceMappingBatchSize}
      MaximumBatchingWindowInSeconds: !Sub ${PnDeliveryAsseverationEventSourceMappingMaximumBatchingWindowInSeconds}
      FunctionName: !GetAtt PnDeliveryAsseverationLambda.Arn

  PnDeliveryAsseverationLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref PnDeliveryAsseverationLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn

  PnDeliveryAsseverationLambda:
    Type: "AWS::Lambda::Function"
    Properties:
      Handler: index.handler
      Runtime: nodejs20.x
      FunctionName: !Ref PnDeliveryAsseverationLambdaName
      Description: "It triggers the asseveration written of sqs"
      MemorySize: !Ref PnDeliveryAsseverationLambdaMemory
      Timeout: !Ref PnDeliveryAsseverationLambdaTimeout
      Role: !GetAtt PnDeliveryAsseverationLambdaRole.Arn
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Environment:
        Variables:
          BUCKET_NAME: !Sub "${LogsBucketName}"
      Code:
        ZipFile: |
          const { S3Client, PutObjectCommand } = require("@aws-sdk/client-s3");
          const crypto = require('node:crypto');

          const BUCKET_NAME = process.env.BUCKET_NAME
          const client = new S3Client();

          async function putObjectToS3(bucket, key, data){
              const params = {
                  Bucket : bucket,
                  Key : key,
                  Body : data
              }
              const command = new PutObjectCommand(params);
              await client.send(command);             
          }

          function uuidv4(crypto) {
              return crypto.randomUUID()
          }

          function s3KeyName( d, namePrefix ) {
              const ye = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(d);
              const mo = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(d);
              const da = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(d);
              
              const h = new Intl.DateTimeFormat('it', { hour: '2-digit' }).format(d);
              const m = new Intl.DateTimeFormat('en', { minute: '2-digit' }).format(d);
              const s = new Intl.DateTimeFormat('en', { second: '2-digit' }).format(d);
              
              return ye + '/' + mo + '/' + da + '/' + h + '/' + namePrefix 
                    + '_' + ye + '' + mo + '' + da + '-' + h + '' + m + '' + s 
                    + '_' + uuidv4( crypto );
          }

          module.exports.handler = async(event) => {
              console.log( "Numero elementi: " + event.Records.length ) ;
              
              const messages = event.Records.map( el => el.body )
                  .map( el => ''+ el).map( el => el.replace(/(\r\n|\n|\r)/gm, '') );
              const response = messages.join('\n');
              console.log( response );
              
              const now = new Date();
              const fullPath = 'flussi/pad26_asseverazione/' 
                            + s3KeyName( now, 'pad26' ) + '.json';
              
              
              await putObjectToS3(BUCKET_NAME, fullPath, response);
              return response;
          };

  #########################################################
  ###              VersioningV1V2GetNotification        ### # converte la risposta V2.0 a V1 e verr√† estesa per convertire V2.1 a V1
  #########################################################
  VersioningV1V2GetNotificationSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${VersioningV1V2GetNotificationLambdaName}-sec-group"
      VpcId: !Ref VpcId

  # Lambda function
  VersioningV1V2GetNotificationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref VersioningV1V2GetNotificationLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/versioningV1V2GetNotification.zip"
      Role: !GetAtt VersioningV1V2GetNotificationLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt VersioningV1V2GetNotificationSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_DELIVERY_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080/delivery/v2.6"
          NUM_RETRY: !Ref NumRetry
          ATTEMPT_TIMEOUT_SEC: !Ref AttemptTimeoutSec
          ENABLE_DECEASED_WORKFLOW: !Ref EnableDeceasedWorkflow
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 30
      MemorySize: !Ref LambdaMemorySize
      Tags:
        - Key: "pn-eni-related"
          Value: "true"
        - Key: "pn-eni-related-groupName-regexp"
          Value: !Base64 "^pn-delivery-microsvc-prod-VersioningV1V2GetNotificationSecGroup*$"

  # a new version at each deploy, with provisioned concurrency set
  VersioningV1V2GetNotificationLambdaVersionPnPlaceholderEpochSeconds:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref VersioningV1V2GetNotificationLambda

  VersioningV1V2GetNotificationLambdaVersionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref VersioningV1V2GetNotificationLambda
      FunctionVersion: !GetAtt VersioningV1V2GetNotificationLambdaVersionPnPlaceholderEpochSeconds.Version
      Name: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref VersioningV1V2GetNotificationLambdaProvisionedConcurrency

  # Lambda function role
  VersioningV1V2GetNotificationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-versioningV1V2GetNotificationLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        # - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        # - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy

  VersioningV1V2GetNotificationLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref VersioningV1V2GetNotificationLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda access right
  VersioningV1V2GetNotificationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref VersioningV1V2GetNotificationLambdaVersionAlias
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*"

  #########################################################
  ###        VersioningV1V21SendNewNotification         ###
  #########################################################
  VersioningV1V21SendNewNotificationSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${VersioningV1V21SendNewNotificationLambdaName}-sec-group"
      VpcId: !Ref VpcId

  # Lambda function
  VersioningV1V21SendNewNotificationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref VersioningV1V21SendNewNotificationLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/versioningV1V21SendNewNotification.zip"
      Role: !GetAtt VersioningV1V21SendNewNotificationLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt VersioningV1V21SendNewNotificationSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_DELIVERY_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080/delivery/v2.4"
          NUM_RETRY: !Ref NumRetry
          ATTEMPT_TIMEOUT_SEC: !Ref AttemptTimeoutSec
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 30
      MemorySize: !Ref LambdaMemorySize
      Tags:
        - Key: "pn-eni-related"
          Value: "true"
        - Key: "pn-eni-related-groupName-regexp"
          Value: !Base64 "^pn-delivery-microsvc-prod-VersioningV1V21SendNewNotificationSecGroup*$"

  # a new version at each deploy, with provisioned concurrency set
  VersioningV1V21SendNewNotificationLambdaVersionPnPlaceholderEpochSeconds:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref VersioningV1V21SendNewNotificationLambda

  VersioningV1V21SendNewNotificationLambdaVersionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref VersioningV1V21SendNewNotificationLambda
      FunctionVersion: !GetAtt VersioningV1V21SendNewNotificationLambdaVersionPnPlaceholderEpochSeconds.Version
      Name: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref VersioningV1V21SendNewNotificationLambdaProvisionedConcurrency

  # Lambda function role
  VersioningV1V21SendNewNotificationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-versioningV1V21SendNewNotificationLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
       # - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        # - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy

  VersioningV1V21SendNewNotificationLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref VersioningV1V21SendNewNotificationLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda access right
  VersioningV1V21SendNewNotificationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref VersioningV1V21SendNewNotificationLambdaVersionAlias
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*"

  #########################################################
  ###    VersioningV1V21GetNotificationRequestStatus    ###
  #########################################################
  VersioningV1V21GetNotificationRequestStatusSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${VersioningV1V21GetNotificationRequestStatusLambdaName}-sec-group"
      VpcId: !Ref VpcId

  # Lambda function
  VersioningV1V21GetNotificationRequestStatusLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref VersioningV1V21GetNotificationRequestStatusLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/versioningV1V21GetNotificationRequestStatus.zip"
      Role: !GetAtt VersioningV1V21GetNotificationRequestStatusLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt VersioningV1V21GetNotificationRequestStatusSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_DELIVERY_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080/delivery/v2.4"
          NUM_RETRY: !Ref NumRetry
          ATTEMPT_TIMEOUT_SEC: !Ref AttemptTimeoutSec
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 30
      MemorySize: !Ref LambdaMemorySize
      Tags:
        - Key: "pn-eni-related"
          Value: "true"
        - Key: "pn-eni-related-groupName-regexp"
          Value: !Base64 "^pn-delivery-microsvc-prod-VersioningV1V21GetNotificationRequestStatusSecGroup*$"

  # a new version at each deploy, with provisioned concurrency set
  VersioningV1V21GetNotificationRequestStatusLambdaVersionPnPlaceholderEpochSeconds:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref VersioningV1V21GetNotificationRequestStatusLambda

  VersioningV1V21GetNotificationRequestStatusLambdaVersionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref VersioningV1V21GetNotificationRequestStatusLambda
      FunctionVersion: !GetAtt VersioningV1V21GetNotificationRequestStatusLambdaVersionPnPlaceholderEpochSeconds.Version
      Name: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref VersioningV1V21GetNotificationRequestStatusLambdaProvisionedConcurrency

  # Lambda function role
  VersioningV1V21GetNotificationRequestStatusLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-versioningV1V21GetNotificationRequestStatusLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        # - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        # - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy

  VersioningV1V21GetNotificationRequestStatusLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref VersioningV1V21GetNotificationRequestStatusLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda access right
  VersioningV1V21GetNotificationRequestStatusLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref VersioningV1V21GetNotificationRequestStatusLambdaVersionAlias
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*"

  #########################################################
  ###       VersioningV1V23GetNotificationPrice         ###
  #########################################################
  VersioningV1V23GetNotificationPriceSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${VersioningV1V23GetNotificationPriceLambdaName}-sec-group"
      VpcId: !Ref VpcId

  # Lambda function
  VersioningV1V23GetNotificationPriceLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref VersioningV1V23GetNotificationPriceLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/versioningV1V23GetNotificationPrice.zip"
      Role: !GetAtt VersioningV1V23GetNotificationPriceLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt VersioningV1V23GetNotificationPriceSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_DELIVERY_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080/delivery/v2.3"
          NUM_RETRY: !Ref NumRetry
          ATTEMPT_TIMEOUT_SEC: !Ref AttemptTimeoutSec
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 30
      MemorySize: !Ref LambdaMemorySize
      Tags:
        - Key: "pn-eni-related"
          Value: "true"
        - Key: "pn-eni-related-groupName-regexp"
          Value: !Base64 "^pn-delivery-microsvc-prod-VersioningV1V23GetNotificationPriceSecGroup*$"

  # a new version at each deploy, with provisioned concurrency set
  VersioningV1V23GetNotificationPriceLambdaVersionPnPlaceholderEpochSeconds:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref VersioningV1V23GetNotificationPriceLambda

  VersioningV1V23GetNotificationPriceLambdaVersionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref VersioningV1V23GetNotificationPriceLambda
      FunctionVersion: !GetAtt VersioningV1V23GetNotificationPriceLambdaVersionPnPlaceholderEpochSeconds.Version
      Name: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref VersioningV1V23GetNotificationPriceLambdaProvisionedConcurrency

  # Lambda function role
  VersioningV1V23GetNotificationPriceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-versioningV1V23GetNotificationPriceLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        # - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        # - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy

  VersioningV1V23GetNotificationPriceLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref VersioningV1V23GetNotificationPriceLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda access right
  VersioningV1V23GetNotificationPriceLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref VersioningV1V23GetNotificationPriceLambdaVersionAlias
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*"

  #########################################################
  ###              MetadataStatusUpdaterLambda            ###
  #########################################################
  MetadataStatusUpdaterSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${MetadataStatusUpdaterLambdaName}-sec-group"
      VpcId: !Ref VpcId

  # Lambda function
  MetadataStatusUpdaterLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref MetadataStatusUpdaterLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/metadataStatusUpdater.zip"
      Role: !GetAtt MetadataStatusUpdaterLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt MetadataStatusUpdaterSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_EXTERNAL_REGISTRIES_BASE_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080"
          PN_MANDATE_BASE_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080"
      TracingConfig:
        Mode: Active
    #  Layers:
       # - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 30

  MetadataStatusUpdaterLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref MetadataStatusUpdaterLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda function role
  MetadataStatusUpdaterLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-metadataStatusUpdaterLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

  # Lambda function IAM policy
  MetadataStatusUpdaterLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-MetadataStatusUpdaterLambdaPolicy
      Roles:
        - !Ref MetadataStatusUpdaterLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:GetItem"
            Resource: !Sub "${NotificationsDynamoTableArn}"
          - Effect: Allow
            Action:
              - "dynamodb:GetItem"
              - "dynamodb:PutItem"
            Resource:
              - !Sub "${NotificationsMetadataDynamoTableArn}"
              - !Sub "${NotificationsMetadataDynamoTableArn}/*"
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}"
              - !Sub "${NotificationDelegationMetadataDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - "dynamodb:DeleteItem"
            Resource:
              - !Sub "${NotificationsCostDynamoTableArn}"
              - !Sub "${NotificationsCostDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdcKinesisSourceStreamArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource: !Ref CdcKinesisSourceStreamKeyArn
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref PnDeliveryMetadataStatusDLQARN

  # CDC to Webhook Event Manager
  MetadataStatusUpdaterLambdaKinesisSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Sub ${PnDeliveryMetadataStatusLambdaBatchSize}
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcKinesisSourceStreamArn
      FilterCriteria:
        Filters:
          - Pattern: '{ "data" : { "tableName" : [ "pn-Timelines" ], "dynamodb" : { "NewImage" : { "statusInfo": { "M": { "statusChanged": { "BOOL": [ true ]}}}}}}}'
      FunctionName: !Ref MetadataStatusUpdaterLambda
      FunctionResponseTypes:
        - ReportBatchItemFailures
      MaximumBatchingWindowInSeconds: !Sub ${PnDeliveryMetadataStatusUpdaterLambdaMaximumBatchingWindowInSeconds}
      MaximumRetryAttempts: !Sub ${PnDeliveryMetadataStatusLambdaMaxRetryAttempts}
      StartingPosition: TRIM_HORIZON
      DestinationConfig:
        OnFailure:
          Destination: !Ref PnDeliveryMetadataStatusDLQARN

  #########################################################
  ###        NotificationRefusedDispatcherLambda        ###
  #########################################################

  # Lambda function
  NotificationRefusedDispatcherLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref NotificationRefusedDispatcherLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/notificationRefusedDispatcher.zip"
      Role: !GetAtt NotificationRefusedDispatcherLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          QUEUE_URL: !Ref PnNotificationRefusedQueueURL
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 10

  # Lambda function role
  NotificationRefusedDispatcherLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-notificationRefusedDispatcherLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda function IAM policy
  NotificationRefusedDispatcherLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-NotificationRefusedDispatcherLambdaPolicy
      Roles:
        - !Ref NotificationRefusedDispatcherLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdcKinesisSourceStreamArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource: !Ref CdcKinesisSourceStreamKeyArn
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref PnNotificationRefusedQueueARN
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref PnNotificationRefusedDispatcherDLQARN

  # CDC to Notification Refused Dispatcher
  NotificationRefusedDispatcherLambdaKinesisSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Sub ${NotificationRefusedDispatcherLambdaBatchSize}
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcKinesisSourceStreamArn
      FunctionName: !Ref NotificationRefusedDispatcherLambda
      FunctionResponseTypes:
        - ReportBatchItemFailures
      FilterCriteria:
        Filters:
          - Pattern: '{ "data" : { "tableName" : [ "pn-Timelines" ], "eventName": [ "INSERT" ], "dynamodb" : { "NewImage" : { "category" : { "S" : [ "REQUEST_REFUSED" ] } }}}}'
      MaximumBatchingWindowInSeconds: !Sub ${NotificationRefusedDispatcherLambdaMaximumBatchingWindowInSeconds}
      StartingPosition: TRIM_HORIZON
      DestinationConfig:
        OnFailure:
          Destination: !Ref PnNotificationRefusedDispatcherDLQARN

  NotificationRefusedDispatcherLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref NotificationRefusedDispatcherLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn

  #########################################################
  ###                 PaLimitCorrection                 ###
  #########################################################

  # Lambda function
  PaLimitCorrectionLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref PaLimitCorrectionLambdaName
      Runtime: nodejs20.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/paLimitCorrection.zip"
      Role: !GetAtt PaLimitCorrectionLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          SEARCH_SLA_LAMBDA_ARN: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:pn-searchSLAViolationsLambda"
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: !Ref PaLimitCorrectionLambdaTimeout

  PaLimitCorrectionLambdaInvokeConfig:
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      FunctionName: !Ref PaLimitCorrectionLambda
      Qualifier: "$LATEST"
      MaximumRetryAttempts: !Ref PaLimitCorrectionLambdaMaximumRetryAttempts
      DestinationConfig:
        OnFailure:
          Destination: !Ref PnDeliveryPaLimitCorrectionDLQARN

  PaLimitCorrectionLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref PaLimitCorrectionLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda function role
  PaLimitCorrectionLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-paLimitCorrectionLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

  # Lambda function IAM policy
  PaLimitCorrectionLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-PaLimitCorrectionLambdaPolicy
      Roles:
        - !Ref PaLimitCorrectionLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
              - lambda:InvokeAsync
            Resource:
              !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:pn-searchSLAViolationsLambda"
          - Effect: Allow
            Action:
              - "dynamodb:Query"
            Resource:
              - !Sub "${NotificationsMetadataDynamoTableArn}"
              - !Sub "${NotificationsMetadataDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - "dynamodb:UpdateItem"
              - "dynamodb:Query"
            Resource:
              - !Sub "${PaNotificationLimitDynamoTableArn}"
              - !Sub "${PaNotificationLimitDynamoTableArn}/*"
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref PnDeliveryPaLimitCorrectionDLQARN

  #Scheduled Event Bridge Rule that send event to target lambda
  PaLimitCorrectionScheduledRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-delivery-paLimitCorrectionScheduleRule'
      ScheduleExpression: !Sub cron(${PnDeliveryPaLimitCorrectionLambdaCron})
      State: ENABLED
      Targets:
        - Arn: !GetAtt PaLimitCorrectionLambda.Arn
          Id: PaLimitCorrectionLambdaTarget
          Input: '{ "dateToVerifyLimit": null }'

  PermissionForEventsToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt PaLimitCorrectionLambda.Arn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt PaLimitCorrectionScheduledRule.Arn