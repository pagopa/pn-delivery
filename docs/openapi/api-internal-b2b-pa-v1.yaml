openapi: 3.0.3
info:
  termsOfService: https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/informativa-privacy/index.html
  x-api-id: api-internal-b2b-pa # NO EXTERNAL
#  x-api-id: api-external-b2b-pa # ONLY EXTERNAL
  title: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  x-summary: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  version: '1.0.0'
  description: >-
  
    ## Abstract
      API utilizzate dalle pubbliche amministrazioni per __inviare richieste di notifiche__ e 
      __ottenere informazioni in modalità pull__ sullo stato della 
      _"richiesta di notifica"_ (accettata o rifiutata) e, in caso di richiesta accettata, 
      sulle comunicazioni effettuate, o solo tentate, nei confronti dei destinatari della notifica.
    
    ## Operazioni utilizzate, in sequenza temporale
    
    <table>

    <tr>
    
    <td>
    
     >>>>> <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="314" height="334"><desc>title%20Richiesta%20presigned%20Url%0Aparticipant%20PA%0Aparticipant%20PN%0Aspace%0Aspace%0APA-%3EPN%3ApresignedUploadRequest%20(1.a)%0APN-%3EPA%3Apresigned%20urls%20%5B%20%5D%20(1.a)</desc><defs/><g><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="314" height="334"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="43.494814299363924" y="24.50280495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Richiesta presigned Url</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 35.12536705471875 95.887643371 L 35.12536705471875 334.381611551" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 278.3493918540677 95.887643371 L 278.3493918540677 334.381611551" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 8.167601650000002 51.782594461 L 62.0831324594375 51.782594461 L 62.0831324594375 95.887643371 L 8.167601650000002 95.887643371 L 8.167601650000002 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="25.8912972305" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 250.44316300940753 51.782594461 L 306.25562069872785 51.782594461 L 306.25562069872785 95.887643371 L 250.44316300940753 95.887643371 L 250.44316300940753 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="268.1668585899075" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g></g><g><g><g><rect fill="white" stroke="none" x="54.45535762638538" y="210.234066471" width="204.56404365601563" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="56.90563812138538" y="224.93574944099998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presignedUploadRequest (1.a)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 35.12536705471875 231.469830761 L 264.900074470401 231.469830761" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(278.3493918540677,231.469830761) translate(-278.3493918540677,-231.469830761)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 264.736722437401 224.66349605266666 L 278.3493918540677 231.469830761 L 264.736722437401 238.27616546933334 Z"/></g></g><g><g><rect fill="white" stroke="none" x="82.99150569767444" y="255.97263571099998" width="147.4917475134375" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="85.44178619267444" y="270.674318681" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presigned urls [ ] (1.a)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 278.3493918540677 277.208400001 L 48.57468443838542 277.208400001" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(35.12536705471875,277.208400001) translate(-35.12536705471875,-277.208400001)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 48.73803647138542 270.40206529266663 L 35.12536705471875 277.208400001 L 48.73803647138542 284.0147347093333 Z"/></g></g></g><g/><g/></g></svg>
      
      </br>
      
      #### 1.b Upload allegati
      
      Per ogni allegato utilizzare un richiesta HTTP con metodo _httpMethod_ (POST o PUT) 
      all'url indicato dal campo _url_. <br/>
      In tale richiesta vanno aggiunti i seguenti header: <br/>
      \- _content-type_: valorizzato come il campo "contentType" della richiesta di cui al punto (1.a) <br/>
      \- _x-amz-meta-secret_: valorizzato con il valore del campo "secret" della risposta di cui al punto (1.a) <br/>
      \- _trailer_: valorizzato con ```x-amz-checksum-sha256``` <br/>
      \- _x-amz-checksum-sha256_: valorizzato con il checksum sha256, codificato in base 64, del contenuto binario del file che verrà caricato. (__N.B.__ questo è un trailer HTTP non un header).
        Vedi [HTTP Trailer](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Trailer) <br/>
  
      Dalla risposta va letto l'header _x-amz-version-id_ che verrà usato nell'invocazione 
      successiva di richiesta creazione della notifica. Questo garantisce che eventuali utilizzi multipli (anche malevoli) del 
      presignedUrl non vadano a sovrascrivere il file generando disservizi.
      
      </br>
      
      
      >>>>><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="270" height="252"><desc>title%20Invio%20notifica%0Aparticipant%20PA%0Aparticipant%20PN%0APA-%3EPN%3AsendNewNotification%20(2)%0APN-%3EPA%3AreqId%20(2)</desc><defs/><g><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="270" height="252"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="74.04847946049674" y="24.50280495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Invio notifica</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 35.12536705471875 95.887643371 L 35.12536705471875 252.705595051" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 234.3121909263333 95.887643371 L 234.3121909263333 252.705595051" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 8.167601650000002 51.782594461 L 62.0831324594375 51.782594461 L 62.0831324594375 95.887643371 L 8.167601650000002 95.887643371 L 8.167601650000002 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="25.8912972305" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 206.40596208167315 51.782594461 L 262.2184197709935 51.782594461 L 262.2184197709935 95.887643371 L 206.40596208167315 95.887643371 L 206.40596208167315 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="224.12965766217314" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g></g><g><g><g><rect fill="white" stroke="none" x="54.45535762638538" y="128.558049971" width="160.52684272828125" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="56.90563812138538" y="143.259732941" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">sendNewNotification (2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 35.12536705471875 149.793814261 L 220.86287354266665 149.793814261" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(234.3121909263333,149.793814261) translate(-234.3121909263333,-149.793814261)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 220.69952150966662 142.98747955266666 L 234.3121909263333 149.793814261 L 220.69952150966662 156.60014896933333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="104.56629665226428" y="174.296619211" width="60.30496467652344" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.01657714726429" y="188.99830218099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">reqId (2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 234.3121909263333 195.532383501 L 48.57468443838542 195.532383501" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(35.12536705471875,195.532383501) translate(-35.12536705471875,-195.532383501)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 48.73803647138542 188.72604879266666 L 35.12536705471875 195.532383501 L 48.73803647138542 202.33871820933334 Z"/></g></g></g><g/><g/></g></svg>
      
      </br>
      </br>
      </br>
      
      #### 3. Verifica accettazione richiesta di invio notifica
    
      Per questa verifica possono essere utilizzate due modalità:
      
      1. __richiesta puntale__: consigliato solo ai fini di test
      2. __lettura da stream configurato__: consigliato per ambienti di produzione
      
      La differenza tra le due modalità è nell'interazione e nell'efficienza.
      
      Con la modalità _richiesta puntuale_ è necessario l'invocazione per ogni notifica.
      Mentre con la modalità _"stream"_ è possibile avere gli aggiornamenti
      di stato di più notifiche con una sola invocazione.
      
      #### 3.1 Richiesta puntuale di verifica accettazione
    
      Questa modalità è resa disponibile solo ai fini di test o di eventuali operazioni
      di allineamento poiché richiede l'invio di una richiesta per ogni notifica.
      Se il passo (2) avviene con successo si utilizza l'operazione 
      [getNotificationRequestStatus](#/SenderRead/getNotificationRequestStatus)
      per ottenere informazioni riguardo allo stato della "richiesta di invio di notifica". </br>
      Nel campo _notificationRequestStatus_ sarà indicato:</br>
      \- WAITING: se la validazione è ancora in corso.</br>
      \- ACCEPTED: se richiesta di notifica accettata, lo _IUN_ è valorizzato.</br>
      \- REFUSED: se richiesta di notifica rifiutata, è valorizzato il campo _errors_.</br>
      
      #### 3.2 Richiesta avanzamento via "stream" di verifica di accettazione
    
      Questa modalità è consigliata. Per essere fruita è necessaria una operazione preliminare 
      tramite la chiamata alla API [createEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload:``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS",
        "filterValues": [
          "ACCEPTED"
        ]
      }
      ``
      Successivamente si possono ottenere i dati richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml#/Events/consumeEventStream)
      
      
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.
      
      </br>
      </br>
      </br>
      </br>
      
    </td>
    
    <td>
    
      ### Ciclo di vita della notifica lato mittente
      
      #### 1. Caricamento allegati della notifica
      
      Prima di invocare la richiesta di notifica è necessario caricare gli allegati (documenti e bollettini di pagamento).
      
      #### 1.a. Richiesta presigned Url
      
      Invocare l'operazione [presignedUploadRequest](#/NewNotification/presignedUploadRequest) 
      con cui prenotare il caricamento. </br> 
      In risposta di ottengono le seguenti informazioni:<br/>
      \- httpMethod <br/>
      \- secret <br/>
      \- url <br/>
      L'url restituito ha una validità di 1h.
      
      </br>
      </br>
      </br>
      
      >>>><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="351" height="321"><desc>title%20Upload%20allegato%0Aparticipant%20PA%0Aparticipant%20PN%20Safe-Storage%0Aloop%20upload%0APA-%3EPN%20Safe-Storage%3AattachmentUpload%20(1.b)%0APN%20Safe-Storage-%3EPA%3Aresult%20(1.b)%0Aend</desc><defs/><g><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="351" height="321"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="99.33896804929947" y="24.50280495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Upload allegato</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 95.887643371 L 73.50841485 321.313448911" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 270.2686182382161 95.887643371 L 270.2686182382161 321.313448911" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 46.550649445281245 51.782594461 L 100.46618025471875 51.782594461 L 100.46618025471875 95.887643371 L 46.550649445281245 95.887643371 L 46.550649445281245 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="64.27434502578124" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 197.13334734033327 51.782594461 L 343.4038891360989 51.782594461 L 343.4038891360989 95.887643371 L 197.13334734033327 95.887643371 L 197.13334734033327 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="214.8570429208333" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN Safe-Storage</text></g></g><g><g><g><rect fill="white" stroke="none" x="92.83840542166662" y="172.663098881" width="158.10022224488281" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="95.28868591666662" y="187.36478185099998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">attachmentUpload (1.b)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 193.898863171 L 256.81930085454945 193.898863171" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(270.2686182382161,193.898863171) translate(-270.2686182382161,-193.898863171)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 256.65594882154943 187.09252846266665 L 270.2686182382161 193.898863171 L 256.65594882154943 200.70519787933333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="134.4060476335807" y="218.401668121" width="74.96493782105469" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="136.85632812858069" y="233.10335109099998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">result (1.b)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 270.2686182382161 239.637432411 L 86.95773223366666 239.637432411" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(73.50841485,239.637432411) translate(-73.50841485,-239.637432411)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 87.12108426666666 232.83109770266665 L 73.50841485 239.637432411 L 87.12108426666666 246.44376711933333 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203299999996 128.55804997099997 L 327.4418297882161 128.55804997099997 L 327.4418297882161 264.140237361 L 16.335203299999996 264.140237361 L 16.335203299999996 128.55804997099997 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 16.335203299999996 128.55804997099997 L 16.335203299999996 148.16029393099998 L 73.76000443125 148.16029393099998 L 83.56112641125 138.35917195099998 L 83.56112641125 128.55804997099997 L 16.335203299999996 128.55804997099997" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="32.67040659999999" y="141.62621261099997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">loop</text><g><rect fill="white" stroke="none" x="97.44604921625" y="129.86486623499997" width="51.15611518921875" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="99.89632971125" y="141.62621261099997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[upload]</text></g></g><g/><g/></g></svg>
      
      </br>
      </br>
      </br>
      
      #### 2. Richiesta di invio della notifica
    
      Per effettuare una richiesta di invio notifica, invocare l'operazione 
      [sendNewNotification](#/NewNotification/sendNewNotification) utilizzando i riferimenti dei file 
      caricati ottenuti al punto (1.b).
      
      </br>
      </br>
      </br>
      </br>
      </br>
      
      
    >>><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="500" height="731"><desc>title%20Verifica%20accettazione%20richiesta%20di%20invio%20notifica%0Aparticipant%20PA%0Aparticipant%20PN%0Aalt%20single%20request%20check%0Anote%20over%20PA%2CPN%3AOnly%20for%20test%20purpose%0Aloop%20check%0APA-%3EPN%3AgetNotificationRequestStatus(reqId)%20(3.1)%0APN%20-%3EPA%3AIUN%20(3.1)%0Aend%0Aspace%0Aspace%0Aelse%20Stream%20solution%0Anote%20over%20PA%2CPN%3ASee%20%3Clink%3Ahttps%3A%2F%2Fpetstore.swagger.io%2F%3Furl%3Dhttps%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml%3EAPI%20B2B%20avanzamento%20notifiche%3C%2Flink%3E%0APA-%3EPN%3AgetEvents(Stream)%20(3.2)%0APN-%3EPA%3Aevents%20%5B%20%5D%20(3.2)%0Aend</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="489" height="731"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="24.73938299108073" y="24.50280495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Verifica accettazione richiesta di invio notifica</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 95.887643371 L 89.84361815 731.3270517409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 95.887643371 L 399.86073376966146 731.3270517409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 62.88585274528125 51.782594461 L 116.80138355471874 51.782594461 L 116.80138355471874 95.887643371 L 62.88585274528125 95.887643371 L 62.88585274528125 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="80.60954832578125" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 371.9545049250013 51.782594461 L 427.7669626143216 51.782594461 L 427.7669626143216 95.887643371 L 371.9545049250013 95.887643371 L 371.9545049250013 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="389.6782005055013" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g></g><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 75.14193517999999 172.663098881 L 399.86073376966146 172.663098881 L 414.56241673966144 187.364781851 L 414.56241673966144 210.23406647099998 L 75.14193517999999 210.23406647099998 L 75.14193517999999 172.663098881 M 399.86073376966146 172.663098881 L 399.86073376966146 187.364781851 L 414.56241673966144 187.364781851" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="176.813548335319" y="195.53238350099994" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Only for test purpose</text></g><g><g><rect fill="white" stroke="none" x="109.17360872166667" y="278.8419203309999" width="271.3571344763281" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="111.62388921666667" y="293.5436033009999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">getNotificationRequestStatus(reqId) (3.1)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 300.07768462099995 L 386.4114163859948 300.07768462099995" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(399.86073376966146,300.07768462099995) translate(-399.86073376966146,-300.07768462099995)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 386.2480643529948 293.2713499126666 L 399.86073376966146 300.07768462099995 L 386.2480643529948 306.8840193293333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="212.67033571141278" y="324.58048957099993" width="64.36368049683594" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="215.12061620641276" y="339.2821725409999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IUN (3.1)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 345.81625386099995 L 103.29293553366666 345.81625386099995" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(89.84361815,345.81625386099995) translate(-89.84361815,-345.81625386099995)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 103.45628756666666 339.0099191526666 L 89.84361815 345.81625386099995 L 103.45628756666666 352.6225885693333 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 75.14193517999999 520.6029291709999 L 399.86073376966146 520.6029291709999 L 414.56241673966144 535.3046121409999 L 414.56241673966144 558.1738967609999 L 75.14193517999999 558.1738967609999 L 75.14193517999999 520.6029291709999 M 399.86073376966146 520.6029291709999 L 399.86073376966146 535.3046121409999 L 414.56241673966144 535.3046121409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="126.68471837926432" y="543.472213791" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">See </text><a xlink:href="https://petstore.swagger.io/?url=https://raw.githubusercontent.com/pagopa/pn-delivery-push/develop/docs/openapi/api-external-b2b-webhook-v1.yaml"><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="underline" x="156.84218908238932" y="543.472213791" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">API B2B avanzamento notifiche</text></a></g><g><g><rect fill="white" stroke="none" x="164.18790620701824" y="582.6767017109999" width="161.328539505625" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="166.63818670201823" y="597.3783846809998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">getEvents(Stream) (3.2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 603.9124660009999 L 386.4114163859948 603.9124660009999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(399.86073376966146,603.9124660009999) translate(-399.86073376966146,-603.9124660009999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 386.2480643529948 597.1061312926665 L 399.86073376966146 603.9124660009999 L 386.2480643529948 610.7188007093332 Z"/></g></g><g><g><rect fill="white" stroke="none" x="195.55152315037762" y="628.4152709509998" width="98.60130561890625" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="198.0018036453776" y="643.1169539209998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">events [ ] (3.2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 649.6510352409998 L 103.29293553366666 649.6510352409998" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(89.84361815,649.6510352409998) translate(-89.84361815,-649.6510352409998)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 103.45628756666666 642.8447005326665 L 89.84361815 649.6510352409998 L 103.45628756666666 656.4573699493332 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 128.55804997099997 L 473.3691486196615 128.55804997099997 L 473.3691486196615 674.1538401909999 L 16.335203300000003 674.1538401909999 L 16.335203300000003 128.55804997099997 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 128.55804997099997 L 16.335203300000003 148.16029393099998 L 62.694406897070316 148.16029393099998 L 72.49552887707031 138.35917195099998 L 72.49552887707031 128.55804997099997 L 16.335203300000003 128.55804997099997" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="32.67040660000001" y="141.62621261099997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><g><rect fill="white" stroke="none" x="86.38045168207032" y="129.86486623499997" width="128.75847114625" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="88.83073217707032" y="141.62621261099997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[single request check]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 476.4978802609999 L 473.3691486196615 476.4978802609999" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray="4.083800825"/></g><g/><g><rect fill="white" stroke="none" x="86.38045168207032" y="477.80469652499994" width="101.35219062867188" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="88.83073217707032" y="489.56604290099995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Stream solution]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 32.6704066 234.73687142099996 L 457.0339453196615 234.73687142099996 L 457.0339453196615 370.31905881099993 L 32.6704066 370.31905881099993 L 32.6704066 234.73687142099996 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 32.6704066 234.73687142099996 L 32.6704066 254.33911538099997 L 90.09520773125 254.33911538099997 L 99.89632971125 244.53799340099997 L 99.89632971125 234.73687142099996 L 32.6704066 234.73687142099996" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="49.005609899999996" y="247.80503406099996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">loop</text><g><rect fill="white" stroke="none" x="113.78125251625" y="236.04368768499995" width="45.972719803476565" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="116.23153301125001" y="247.80503406099996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[check]</text></g><g/></g><g/><g/></g></svg>
    
    </td>
      
    </tr>
    
    </table>
    
    
      ### 4. Monitorare l'avanzamento di una notifica
    
      Allo stesso modo del monitoraggio dell'accettazione della notifica da parte della Piattaforma sono 
      disponibili le due modalità.
      
      #### 4.1 Monitoraggio puntuale
    
      Se la "richiesta di invio di notifica" passa le validazioni viene trasformata in "notifica" e sarà 
      identificata dalla IUN restituito dall'operazione 
      [getNotificationRequestStatus](#/SenderReadB2B/getNotificationRequestStatus).</br> 
      A tal punto si potranno utilizzare l'operazione _GET /delivery/notifications/sent/{iun}_ per 
      ottenere i dettagli della notifica, la _timeline_ che dettaglia il perfezionamento della
      notifica per il mittente e l'avanzamento delle comunicazioni nei confronti dei destinatari.
      
      #### 4.1 Monitoraggio tramite stream
    
      Questa modalità è consigliata in produzione. Per essere fruita è necessaria una operazione preliminare
      tramite la chiamata alla API [createEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload di esempio:``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS"
      }
      ``che permette di monitorare gli eventi di tipo "STATO"
      
      Successivamente si può ottenere il dettaglio della stream appena creata chiamando la 
      API [getEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml#/Streams/getEventStream), mentre si possono ottenere i dati degli eventi richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook-v1.yaml#/Events/consumeEventStream)
  
  
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.
      
      </br>
      
      <details>
        <summary><strong><big><big><big><big>FAQ</big></big></big></big></strong></summary>
        
      <strong><strong>Come avviene l’inoltro della notifica ?</strong></strong></br>_L’inoltro della notifica può avvenire in modalità automatica o manuale.
          _La modalità automatica prevede l’utilizzo della piattaforma PN e consente l’inoltro puntuale di una notifica._ La modalità manuale prevede l’utilizzo dei servizi di PN da parte della PA e consente l’inoltro massivo di notifiche._ </br></br>
        <strong><strong>Quali sono i passi da seguire per effettuare l’inoltro manuale della notifica ?</strong></strong></br>_I passi necessari per eseguire l’inoltro della notifica sono i seguenti:_</br>
       >><em><small><strong>1)</strong> Pre inoltro della documentazione (atto di notifica e moduli di pagamento).</small></em></br>
       >><em><small>Occorre chiamare il servizio <strong>presignedUploadRequest.</strong></small></em></br></br>
       >><em><small><strong>2)</strong> Upload della documentazione.</small></em></br>
       >><em><small>PA o PT devono sviluppare un software che sia in grado di inviare la documentazione a Piattaforma Notifiche. Occorre effettuare, per ogni documento, una richiesta HTTP con metodo httpMethod all'url restituita dal servizio <strong>presignedUploadRequest</strong>.</small></em></br></br>
       >><em><small><strong>3)</strong> Invio della notifica.</em></br>
       >><em>Occorre chiamare il servizio <strong>sendNewNotification</strong>.</em>
       
       <strong><strong>Le chiamate ai servizi esposti da PN sono sicuri ?</strong></strong> </br><em>Si. Le chiamate ai servizi esposti da PN avvengono in modalità https utilizzando API Key. Non sono attualmente previsti meccanismi di crittazione/decrittazione dei documenti e/o accessi basati su mutua autenticazione tramite certificato.</em></br></br>
       <strong><strong>Quale relazione esiste tra eventi di timeline e stati della notifica ?</strong></strong></br><em>Non esiste una corrispondenza 1:1 tra eventi di timeline e cambiamenti di stato; in particolare, solo alcuni eventi di timeline implicano un cambiamento di stato</em></br></br>
       
       <strong><strong>Quando eseguendo l’upload del documento si ottiene il seguente errore:</strong></strong></br>
        <strong>\<Code\>SignatureDoesNotMatch\</Code\></strong></br>
        <strong>\<Message\>The request signature we calculated does not match the signature you provided. Check your key and signing method.\</Message\></strong></br>
        <em>Esistono varie casistiche che generano l’errore descritto; le più frequenti sono:</em></br>
      >><em><small><strong>1)</strong> In uploadAllegati si è utilizzato uno sha256 diverso da quello utilizzato in presignedUploadRequest.</small></em></br>
      >><em><small><strong>2)</strong> in uploadAllegati è stato inserito uno sha256 che non corrisponde al documento che si desidera effettivamente inviare.</small></em></br>
      >><em><small><strong>3)</strong> sha256 corretto in presignedUploadRequest e coincidente con quello caricato in uploadAllegati, ma secret errato.</small></em></br></br>
       
       <strong><strong>Quando si invoca il servizio di upload di un documento, passando x-amz-checksum-sha256 del file, si ottiene il seguente errore: `Value for x-amz-checksum-sha256 header is invalid` cosa bisogna fare?</strong></strong></br><em>Assicurarsi di avere eseguito i seguenti passaggi:</em>
       >><em><small><strong>a)</strong> Applicare al documento l’algoritmo di crittazione, ottenendo una rappresentazione di 64 caratteri in formato esadecimale <strong>^[A-Fa-f0-9]{64}$</strong></small></em></br>
       >><em><small><strong>b)</strong> Ottenere la relativa rappresentazione binaria</small></em></br>
       >><em><small><strong>c)</strong> Applicare la codifica Base64</small></em></br>
       
       >><em>Esempio di codice:</em>
       
       >>     import org.springframework.util.Base64Utils;
       >>     import java.io.ByteArrayInputStream;
       >>     import java.io.InputStream;
       >>     import java.security.MessageDigest;

       >>     MessageDigest digest = MessageDigest.getInstance("SHA-256");
       >>     byte[] encodedhash = digest.digest( StreamUtils.copyToByteArray( docInputStream ) );
       >>     String x-amz-checksum-sha256 = Base64Utils.encodeToString( hash ) 
       
       </br><strong><strong>Come si può verificare che lo <em>"x-amz-checksum-sha256"</em> sia corretto ?</strong></strong></br><em>Aprire la shell di Git Bash o un terminal SSH ed eseguire il comando:</em></br>
       >>     cat <fullPathFile/filename.ext> | openssl dgst -binary -sha256 | openssl base64 –A
       
       Il comando restituisce la codifica base64 della rappresentazione binaria di sha256, che può essere confrontato con quella generata dal codice.
       </br></br>
      
      </details>
      
  contact:
    email: pn@pagopa.it
  license:
    name: Licenza di PN
    url: 'https://da-definire/'
servers:
  - url: https://api.pn.pagopa.it
    description: Ambiente di produzione
  - url: https://api.svil.pn.pagopa.it
    description: Ambiente di test
  - url: https://api.dev.pn.pagopa.it
    description: Ambiente di sviluppo
tags:
  - name: HealthCheck
    description: >-
      Invocazioni per sapere lo stato del microservizio
  - name: NewNotification
    description: >-
      Invocazioni per precaricare allegati e inviare notifiche
  - name: SenderReadB2B
    description: >-
      Invocazioni utilizzabili dai mittenti per verificare lo stato delle richieste 
      di notifica inviate e delle notifiche accettate.
  - name: NotificationPrice
    description: >-
      Invocazioni per determinare il costo della notifica per il destinario.

paths:
  "/status":
    get:
      summary: healthCheck path
      description: healtCheck path per verificare lo stato del microservizio
      tags:
        - HealthCheck
      operationId: status
      responses:
        '200':
          description: Ok
        '500':
          description: Internal Server Error
  ###########################################################################################
  ###                          GESTIONE PRECARICAMENTO ALLEGATI                           ###
  ###########################################################################################
  "/delivery/attachments/preload":
    post:
      summary: Richiesta di pre-caricamento allegati
      description: >-
        Operazione che richiede a Piattaforma Notifica le informazioni e le autorizzazioni necessarie 
        a precaricare uno o più file da allegare a una notifica. <br/>
      tags:
        - NewNotification
      operationId: presignedUploadRequest
      parameters: # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/PreLoadRequest"
        required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PreLoadResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

    ###########################################################################################
    ###                          CREAZIONE RICHIESTE DI NOTIFICA                           ###
    ###########################################################################################

  "/delivery/requests":
    post:
      summary: Richiesta invio notifica
      description: >-
        Operazione utilizzata dalla Pubblica Amministrazione per richiedere l'invio di una notifica.

        La restituzione di uno stato HTTP 202 significa solo che la richiesta è sintatticamente
        valida, non che la richiesta sia stata validata ed accettata. <br/>
        Per conoscere lo stato di accettazione della richiesta di notifica bisogna utilizzare l'operazione
        _getNotificationRequestStatus_ oppure utilizzare la modalità push prevista dai webhook. <br/>
      tags:
        - NewNotification
      operationId: sendNewNotification
      parameters: # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'        # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/NewNotificationRequest"
        required: true
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '409':
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    

    ###########################################################################################
    ###                        VERIFICA STATO RICHIESTE DI NOTIFICA                         ###
    ###########################################################################################
    get:
      operationId: getNotificationRequestStatus
      tags:
        - SenderReadB2B
      summary: Verifica accettazione richiesta notifica
      description: >-
        Questa operazione serve per verificare se la richiesta di notifica è stata accettata e ottenere
        lo IUN associato a tale richiesta. <br/>
        Bisogna specificare il parametro _requestId_ oppure la coppia costituita dai parametri 
        _paProtocolNumber_ e _idempotenceToken_. <br/>
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/notificationRequestId'
        - $ref: '#/components/parameters/paProtocolNumber'
        - $ref: '#/components/parameters/idempotenceToken'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationRequestStatusResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    
    
    ###########################################################################################
    ###                             RICERCA NOTIFICHE ACCETTATE                             ###
    ###########################################################################################
  
  "/delivery/notifications/sent/{iun}":
    get:
      summary: 'Mittente: lettura dettagli notifica'
      description: >-
        Questa operazione permette di leggere tutti i dettagli di una notifica accettata. <br/>
      tags:
        - SenderReadB2B
      operationId: getSentNotification
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'       # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
      responses:
        '200':
          description: OK
          content:
            "*/*":
              schema:
                $ref: "#/components/schemas/FullSentNotification"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    
    ###########################################################################################
    ###                     DOWNLOAD DOCUMENTI E ALLEGATI PER PAGAMENTO                     ###
    ###########################################################################################

  "/delivery/notifications/sent/{iun}/attachments/documents/{docIdx}":
    get:
      summary: Download documento notificato
      tags:
        - SenderReadB2B
      operationId: getSentNotificationDocument
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'        # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'      # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathDocumentIdx'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification-v1.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  "/delivery/notifications/sent/{iun}/attachments/payment/{recipientIdx}/{attachmentName}":
    get:
      summary: Download allegato per pagamento
      tags:
        - SenderReadB2B
      operationId: getSentNotificationAttachment
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathRecipientIdx'
        - $ref: '#/components/parameters/pathAttachmentName'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification-v1.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'


    ###########################################################################################
    ###                          DOWNLOAD ATTI OPPONIBILI A TERZI                           ###
    ###########################################################################################
  '/delivery-push/{iun}/legal-facts/{legalFactType}/{legalFactId}': # ONLY EXTERNAL
    get: # ONLY EXTERNAL
      summary: Download atto opponibile a terzi                                     # ONLY EXTERNAL
      description: Permette di scaricare un atto opponibile a terzi                 # ONLY EXTERNAL
      tags: # ONLY EXTERNAL
        - LegalFacts                                                                # ONLY EXTERNAL
      operationId: getLegalFact                                                     # ONLY EXTERNAL
      parameters: # ONLY EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun' # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactType'                         # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactId'                           # ONLY EXTERNAL
      responses: # ONLY EXTERNAL
        '200': # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: "#/components/schemas/LegalFactDownloadMetadataResponse"      # ONLY EXTERNAL
        '400': # ONLY EXTERNAL
          description: Bad request                                                  # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/problem+json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'     # ONLY EXTERNAL
        '500': # ONLY EXTERNAL
          description: Internal error                                               # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/problem+json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'     # ONLY EXTERNAL
  '/delivery/price/{paTaxId}/{noticeCode}': # ONLY EXTERNAL
    get: # ONLY EXTERNAL
      operationId: getNotificationPrice                                             # ONLY EXTERNAL
      summary: Retrieve notification price and effective date                       # ONLY EXTERNAL
      description: >-                                                               # ONLY EXTERNAL
        Used to retrieve the notification price charged and effective date          # ONLY EXTERNAL
        from PagoPa identifiers paTaxId and noticeCode.                             # ONLY EXTERNAL
        Called from PA to turn notification cost to the receiver during the         # ONLY EXTERNAL
        pagoPa payment verification phase.                                          # ONLY EXTERNAL
      tags: # ONLY EXTERNAL
        - NotificationPrice                                                         # ONLY EXTERNAL
      parameters: # ONLY EXTERNAL
        - name: paTaxId                                                              # ONLY EXTERNAL
          description: Payment PA fiscal code                                       # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '77777777777'                                                    # ONLY EXTERNAL
          schema: # ONLY EXTERNAL
            $ref: 'schemas-pn-notification-v1.yaml#/components/schemas/paTaxId'     # ONLY EXTERNAL
        - name: noticeCode                                                          # ONLY EXTERNAL
          description: Payment notice number  numero avviso                         # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '302000100000019421'                                             # ONLY EXTERNAL
          schema: # ONLY EXTERNAL
            $ref: 'schemas-pn-notification-v1.yaml#/components/schemas/noticeCode'  # ONLY EXTERNAL
      responses: # ONLY EXTERNAL
        '200': # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: '#/components/schemas/NotificationPriceResponse'              # ONLY EXTERNAL
        '400': # ONLY EXTERNAL
          description: Invalid input                                                # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/problem+json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '500': # ONLY EXTERNAL
          description: Internal Server Error                                        # ONLY EXTERNAL
          content: # ONLY EXTERNAL
            application/problem+json: # ONLY EXTERNAL
              schema: # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
components:
  
  parameters:
    ############################################################################################
    ###                     PARAMETRI DI AUTENTICAZIONE E AUTORIZZAZIONE                     ###
    ############################################################################################
    cxTypeAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxTypeAuthFleet'
    cxIdAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxIdAuthFleet'
    cxGroupsAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxGroupsAuthFleet'
    uidAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/uidAuthFleet'

    ############################################################################################
    ###                       PARAMETRI RICERCA RICHIESTA DI NOTIFICA                        ###
    ############################################################################################
    notificationRequestId:
      in: query
      required: false
      name: notificationRequestId
      description: identificativo della richiesta di notifica
      schema:
        type: string
    paProtocolNumber:
      name: paProtocolNumber
      in: query
      required: false
      description: >-
        Numero di protocollo associato alla notifica, può essere riutilizzato per rettifiche.
      schema:
        type: string
    idempotenceToken:
      name: idempotenceToken
      description: >-
        token usato per disambiguare "richieste di notificazione" effetuate con lo stesso 
        numero di protocollo. 
      in: query
      required: false
      schema:
        type: string
    
    
    ############################################################################################
    ###                             PARAMETRI DOWNLOAD DOCUMENTI                             ###
    ############################################################################################
    pathDocumentIdx:
      name: docIdx
      description: indice del documento nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathRecipientIdx:
      name: recipientIdx
      description: indice dei destinatario nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathAttachmentName:
      name: attachmentName
      description: Tipologia del pagamento allegato alla notifica. Valori possibili PAGOPA|F24_FLAT|F24_STANDARD
      in: path
      required: true
      schema:
        type: string
        pattern: "PAGOPA|F24_FLAT|F24_STANDARD"
        #quella sottostante è quella corretta. Riscritta per problemi con tool usato
        #oneOf:
        #  - type: number
        #  - type: string
        #    enum:
        #      - PAGOPA
        #      - F24_FLAT
        #      - F24_STANDARD
    
    
    ############################################################################################
    ###                      PARAMETRI DOWNLOAD ATTI OPPONIBILI A TERZI                      ###
    ############################################################################################
    pathLegalFactType:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactType'
    pathLegalFactId:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactId'


  schemas:
    
    ###########################################################################################
    ###                             DTO PRECARICAMENTO ALLEGATI                             ###
    ###########################################################################################
    PreLoadRequest:
      title: Richiesta di precaricamento di un File
      type: object
      properties:
        preloadIdx:
          title: Id della richiesta di precaricamento di un file
          description: >-
            Identificativo univoco all'interno della request HTTP, serve per correlare la risposta. 
          type: string
        contentType:
          title: MIME type del file che verrà caricato
          description: >-
            Il MIME type dell'allegato che dovrà essere caricato. Attualmente è supportato solo
              - application/pdf
          type: string
          example: application/pdf
        sha256:
          title: checksum sha256 del file che verrà caricato
          description: >-
            checksum sha256, codificato in base 64, del contenuto binario del file che verrà
            caricato
          type: string
          example: jezIVxlG1M1woCSUngM6KipUN3/p8cG5RMIPnuEanlE=

    PreLoadResponse:
      title: Informazioni per il caricamento file
      description: >-
        Per ogni richiesta che è stata fatta viene fornito un presigned URL e le 
        informazioni per usarlo.
      type: object
      properties:
        preloadIdx:
          description: per correlazione con la richiesta
          type: string
        secret:
          description: >-
            Token aggiuntivo per far si che sia necessario intercettare anche gli 
            header e non solo l'URL di upload del contenuto del documento.
          example: AZ23RF12
          type: string
        httpMethod:
          description: >-
            Indica se per l'upload del contenuto file bisogna utilizzare il metodo PUT o POST
          type: string
          example: PUT
          enum:
            - POST
            - PUT
        url:
          description: >-
            URL a cui effettuare l'upload del contenuto del documento.
          type: string
          example: 'https://preloadpn.aws.amazon.......'
        key:
          description: >-
            la chiave restituita sarà globalmente unica e andrà utilizzata nella richiesta 
            di notifica.
          example: 'PN_NOTIFICATION_ATTACHMENTS-0001-301W-B9CB-9U72-WIKD'
          type: string
    NotificationPriceResponse:
      title: Notification price Response
      description: >-
        Notification price and effective date
      type: object
      properties:
        iun:
          $ref: './schemas-pn-notification-v1.yaml#/components/schemas/IUN'
        amount:
          description: amount in euro cents
          example: '1220'
          type: string
        effectiveDate:
          description: notification effective IT local date
          type: string
          format: date-time
          #example: 2017-07-21T17:32:59.645442Z

    ###########################################################################################
    ###                              DTO RICHIESTE DI NOTIFICA                              ###
    ###########################################################################################

    NewNotificationResponse:
      title: Identificativi della richiesta di notifica
      description: >-
        Contiene le informazioni per identificare una richiesta di invio notifica
        che non è ancora stata accettata da Piattaforma notifiche.
      type: object
      required:
        - notificationRequestId
        - paProtocolNumber
      properties:
        notificationRequestId:
          type: string
          description: >-
            identificativo univoco di una richiesta di invio notifica, non è lo IUN
        paProtocolNumber:
          type: string
          description: Identificativo inviato dalla pubblica amministrazione
        idempotenceToken:
          description: >-
            Ripetizione del token usato per disambiguare "richieste di notificazione" 
            effetuate con lo stesso numero di protocollo (campo _paProtocolNumber_). 
          type: string
    
    NewNotificationRequestStatusResponse:
      allOf:
        - $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/NewNotificationRequest"
        - type: object
          required:
            - notificationRequestId
            - notificationRequestStatus
          properties:
            notificationRequestId:
              description: >-
                identificativo univoco di una richiesta di invio notifica, non è lo IUN
              type: string
            notificationRequestStatus:
              description: >-
                - __WAITING__: in attesa di essere valutata
                - __ACCEPTED__: richiesta di notifica accettata, lo IUN è valorizzato
                - __REFUSED__: richiesta di notifica rifiutata, è valorizzato il campo _errors_
              type: string
            retryAfter:
              type: integer
              format: int32
              description: >-
                Numero di secondi da attendere prima di effettuare una nuova richiesta per 
                la stessa entità; valorizzato quando lo status è __WAITING__.
            iun:
              $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/IUN"
            errors:
              description: >-
                Elenco degli errori che hanno causato il rifiuto della richiesta di notifica
              type: array
              items:
                $ref: '#/components/schemas/ProblemError'

    Problem:
      $ref: './remote-refs.yaml#/components/schemas/Problem'
    ProblemError:
      $ref: './remote-refs.yaml#/components/schemas/ProblemError'


    ###########################################################################################
    ###                              DTO NOTIFICA CON DETTAGLI                              ###
    ###########################################################################################

    FullSentNotification:
      description: >-
        Le informazioni riguardanti una notifica (richiesta di notifica accettata) e il 
        processo di inoltro della notifica verso il cittadino.
      allOf:
        - $ref: './schemas-pn-notification-v1.yaml#/components/schemas/SentNotification'
        - type: object
          required:
            - notificationStatus
            - notificationStatusHistory
            - timeline
          properties:
            notificationStatus:
              $ref: '#/components/schemas/NotificationStatus'
            notificationStatusHistory:
              $ref: '#/components/schemas/NotificationStatusHistory'
            timeline:
              description: >-
                elenco dettagliato di tutto ciò che è accaduto durrante il processo di notifica
              type: array
              items:
                $ref: '#/components/schemas/TimelineElement'
    
    TimelineElement:
      $ref: './remote-refs.yaml#/components/schemas/TimelineElement'
    NotificationStatus:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatus'
    NotificationStatusHistory:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatusHistory'
    LegalFactDownloadMetadataResponse:
      $ref: './remote-refs.yaml#/components/schemas/LegalFactDownloadMetadataResponse'

#  securitySchemes:        # ONLY EXTERNAL
#    ApiKeyAuth:           # ONLY EXTERNAL
#      type: apiKey        # ONLY EXTERNAL
#      in: header          # ONLY EXTERNAL
#      name: x-api-key     # ONLY EXTERNAL

#security:                 # ONLY EXTERNAL
#  - ApiKeyAuth: [] # use the same name as under securitySchemes    # ONLY EXTERNAL
              


  
