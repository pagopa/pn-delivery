openapi: 3.0.3
info:
  title: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  version: v1.0
  description: >- 
    ## Abstract
      API utilizzate dalle pubbliche amministrazioni per inviare notifiche e ottenere, in modalità pull,
      informazioni sullo stato della notifica e sugli eventi del percorso di notifica.
    
    ## Operazioni utilizzate, in sequenza temporale

    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="624" height="821"><desc>title%20Invio%20notifica%0A%0Aparticipant%20ChangeMe1%0APA-%3EPN%3A%20presignedUploadRequest%0APN-%3EPA%3A%20presigned%20urls%20%5B%5D%0Aloop%20upload%0APA-%3EAWS%20S3%3A%20attachmentUpload%0AAWS%20S3-%3EPA%3A%20result%0Aend%0APA-%3EPN%3A%20sendNewNotification%0APN-%3EPA%3A%20reqId%0Aalt%20IUN%20async%0APN--%3E(1)PA%3A%20IUN%0Aelse%20IUN%20sync%0APA-%3EPN%3A%20getNotificationRequestStatus(reqId)%0APN-%3EPA%3A%20IUN%0Aend%0A%0A</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="624" height="821"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="251.27780077502894" y="26.3876361" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Invio notifica</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 67.882935479 103.26361593799999 L 67.882935479 821.8027133581371" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 172.88214002464647 103.26361593799999 L 172.88214002464647 821.8027133581371" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 452.29349309131317 103.26361593799999 L 452.29349309131317 821.8027133581371" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 545.6593634771086 103.26361593799999 L 545.6593634771086 821.8027133581371" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 8.795878699999996 55.765870957999994 L 126.96999225799999 55.765870957999994 L 126.96999225799999 103.26361593799999 L 8.795878699999996 103.26361593799999 L 8.795878699999996 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="27.882935478999997" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">ChangeMe1</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 144.561749658 55.765870957999994 L 201.20253039129295 55.765870957999994 L 201.20253039129295 103.26361593799999 L 144.561749658 103.26361593799999 L 144.561749658 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="163.648806437" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 423.0231029154015 55.765870957999994 L 481.56388326722475 55.765870957999994 L 481.56388326722475 103.26361593799999 L 423.0231029154015 103.26361593799999 L 423.0231029154015 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="442.11015969440155" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 499.1556406672248 55.765870957999994 L 592.1630862869924 55.765870957999994 L 592.1630862869924 103.26361593799999 L 499.1556406672248 103.26361593799999 L 499.1556406672248 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="518.2426974462248" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AWS S3</text></g></g><g><g><g><rect fill="white" stroke="none" x="227.09905447385876" y="138.44713073799997" width="170.97752416824218" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="229.73781808385877" y="154.279712398" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presignedUploadRequest</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 172.88214002464647 161.31641535799997 L 437.80961283197985 161.31641535799997" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(452.29349309131317,161.31641535799997) translate(-452.29349309131317,-161.31641535799997)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 437.6336952579798 153.9865164413333 L 452.29349309131317 161.31641535799997 L 437.6336952579798 168.64631427466665 Z"/></g></g><g><g><rect fill="white" stroke="none" x="257.7323857726869" y="187.70405145799995" width="109.71086157058593" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="260.3711493826869" y="203.53663311799997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presigned urls []</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 452.29349309131317 210.57333607799995 L 187.36602028397982 210.57333607799995" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(172.88214002464647,210.57333607799995) translate(-172.88214002464647,-210.57333607799995)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 187.5419378579798 203.24343716133328 L 172.88214002464647 210.57333607799995 L 187.5419378579798 217.90323499466663 Z"/></g></g><g><g><rect fill="white" stroke="none" x="297.0653224914635" y="284.45871715799996" width="124.41085851882812" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="299.70408610146353" y="300.291298818" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">attachmentUpload</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 172.88214002464647 307.32800177799993 L 531.1754832177753 307.32800177799993" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(545.6593634771086,307.32800177799993) translate(-545.6593634771086,-307.32800177799993)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 530.9995656437753 299.9981028613333 L 545.6593634771086 307.32800177799993 L 530.9995656437753 314.6579006946666 Z"/></g></g><g><g><rect fill="white" stroke="none" x="338.6819873779381" y="333.71563787799994" width="41.1775287458789" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="341.32075098793814" y="349.54821953799996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">result</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 545.6593634771086 356.5849224979999 L 187.36602028397982 356.5849224979999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(172.88214002464647,356.5849224979999) translate(-172.88214002464647,-356.5849224979999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 187.5419378579798 349.25502358133326 L 172.88214002464647 356.5849224979999 L 187.5419378579798 363.91482141466656 Z"/></g></g><g><g><rect fill="white" stroke="none" x="243.04905142210094" y="409.36019469799993" width="139.0775302717578" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="245.68781503210096" y="425.19277635799995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">sendNewNotification</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 172.88214002464647 432.2294793179999 L 437.80961283197985 432.2294793179999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(452.29349309131317,432.2294793179999) translate(-452.29349309131317,-432.2294793179999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 437.6336952579798 424.89958040133325 L 452.29349309131317 432.2294793179999 L 437.6336952579798 439.55937823466655 Z"/></g></g><g><g><rect fill="white" stroke="none" x="293.21571936033337" y="458.6171154179999" width="38.744194395292965" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="295.8544829703334" y="474.44969707799993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">reqId</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 452.29349309131317 481.4864000379999 L 187.36602028397982 481.4864000379999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(172.88214002464647,481.4864000379999) translate(-172.88214002464647,-481.4864000379999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 187.5419378579798 474.15650112133324 L 172.88214002464647 481.4864000379999 L 187.5419378579798 488.81629895466654 Z"/></g></g><g><g><rect fill="white" stroke="none" x="297.3157197418031" y="555.371781118" width="30.544193632353515" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="299.9544833518031" y="571.2043627779999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IUN</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 452.29349309131317 570.240582538137 L 187.33739851448001 586.9222359007869" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="7.0367029599999995"/><g transform="translate(172.88214002464647,587.832339938137) rotate(-3.6025909284161064,0,0) translate(-172.88214002464647,-587.832339938137)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 187.5419378579798 580.5024410214703 L 172.88214002464647 587.832339938137 L 187.5419378579798 595.1622388548037 Z"/><g transform="rotate(3.6025909284161064,0,0)"/></g></g><g><g><rect fill="white" stroke="none" x="193.69905294797985" y="661.717721018137" width="237.77752722" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="196.33781655797986" y="677.550302678137" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">getNotificationRequestStatus(reqId)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 172.88214002464647 684.587005638137 L 437.80961283197985 684.587005638137" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(452.29349309131317,684.587005638137) translate(-452.29349309131317,-684.587005638137)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 437.6336952579798 677.2571067214703 L 452.29349309131317 684.587005638137 L 437.6336952579798 691.9169045548038 Z"/></g></g><g><g><rect fill="white" stroke="none" x="297.3157197418031" y="710.974641738137" width="30.544193632353515" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="299.9544833518031" y="726.807223398137" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IUN</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 452.29349309131317 733.8439263581371 L 187.36602028397982 733.8439263581371" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(172.88214002464647,733.8439263581371) translate(-172.88214002464647,-733.8439263581371)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 187.5419378579798 726.5140274414704 L 172.88214002464647 733.8439263581371 L 187.5419378579798 741.1738252748038 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 111.31098912464648 236.96097217799996 L 607.2305143771086 236.96097217799996 L 607.2305143771086 382.9725585979999 L 111.31098912464648 382.9725585979999 L 111.31098912464648 236.96097217799996 Z" stroke-miterlimit="10" stroke-width="2.5131082" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 111.31098912464648 236.96097217799996 L 111.31098912464648 258.07108105799995 L 171.261170337 258.07108105799995 L 181.816224777 247.51602661799996 L 181.816224777 236.96097217799996 L 111.31098912464648 236.96097217799996" stroke-miterlimit="10" stroke-width="2.5131082" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="128.9027465246465" y="251.03437809799993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">loop</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="199.407982177" y="251.03437809799993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[upload]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 111.31098912464648 507.87403613799995 L 513.8646439913132 507.87403613799995 L 513.8646439913132 760.2315624581371 L 111.31098912464648 760.2315624581371 L 111.31098912464648 507.87403613799995 Z" stroke-miterlimit="10" stroke-width="2.5131082" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 111.31098912464648 507.87403613799995 L 111.31098912464648 528.9841450179999 L 160.19450373391163 528.9841450179999 L 170.74955817391162 518.429090578 L 170.74955817391162 507.87403613799995 L 111.31098912464648 507.87403613799995" stroke-miterlimit="10" stroke-width="2.5131082" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="128.9027465246465" y="521.947442058" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="188.34131557391163" y="521.947442058" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[IUN async]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 111.31098912464648 614.219976038137 L 513.8646439913132 614.219976038137" stroke-miterlimit="10" stroke-width="2.5131082" stroke-dasharray="4.39793935"/></g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="188.34131557391163" y="628.293381958137" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[IUN sync]</text></g><g/></g><g/><g/><g/><g/></g></svg>
    
    ### Creazione richesta notifica:
      1. i sistemi della PA invocano l'operazione _presignedUploadRequest_ con cui prenotano
         il caricamento di documenti e altri allegati alla notifica;
      2. i sistemi della PA utilizzano gli URL e le altre informazioni ottenute al punto (1) per
         caricare i file che verranno allegati alla notifica;
      3. per effettuare una richiesta di invio notifica, viene invocata l'operazione 
         _sendNewNotification_ utilizzando i riferimenti dei file caricati ottenuti al punto 2.
    
    ### Monitorare l'avanzamento di una notifica: 
      4. Se il passo (3) avviene con successo si utilizza l'operazione _getNotificationRequestStatus_
         per ottenere informazioni riguardo allo stato della "richiesta di notifica"
      5. Da quando l'operazione al passo (4) restituisce il campo __iun__ valorizzato con valore 
         diverso da `null` significa che la richiesta di invio notifica è stata accettata.
      6. Da ora in poi la "richiesta di notifica" viene trasformata in una "notifica" e sarà
         ricercabile anche con le operazioni _getByIun_ e _search_
    
  contact:
    email: pn@pagopa.it
  license:
    name: Licenza di PN
    url: 'https://da-definire/'
servers:
- url: https://api.pn.pagopa.it
  description: Ambiente di produzione
- url: https://api.uat.pn.pagopa.it
  description: Ambiente di test
- url: https://api.dev.pn.pagopa.it
  description: Ambiente di sviluppo
tags:
  - name: NewNotification
    description: >-
      Invocazioni per precaricare allegati e inviare notifiche
  - name: SenderRead
    description: >-
      Invocazioni utilizzabili dai mittenti per verificare lo stato delle richieste 
      di notifica inviate e delle notifiche accettate.

paths:
    ###########################################################################################
    ###                          GESTIONE PRECARICAMENTO ALLEGATI                           ###
    ###########################################################################################
  "/delivery/attachments/preload":
    post:
      summary: Precaricamento allegati notifica
      description: >-
        Operazione che richiede a Piattaforma Notifica le informazioni e le autorizzazioni necessarie 
        a precaricare uno o più file da allegare a una notifica. <br/>
        <br/>
        L'unico valore ammesso per il parametro _x-pagopa-pn-cx-type_ è `PA`
      tags:
        - NewNotification
      operationId: presignedUploadRequest
      parameters:                                               # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/PreLoadRequest"
        required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PreLoadResponse"
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'

    ###########################################################################################
    ###                          CREAZIONE RICHIESTE DI NOTIFICA                           ###
    ###########################################################################################

  "/delivery/requests":
    post:
      summary: Richiede l'invio di una notifica
      description: >-
        Operazione utilizzata dalla Pubblica Amministrazione per richiedere l'invio di una notifica.

        La restituzione di uno stato HTTP 202 significa semplicemente che la richiesta è sintatticamente
        valida, non che la richiesta sia stata validata ed accettata. <br/>
        Per conoscere lo stato di accettazione della richiesta di notifica bisogna utilizzare l'operazione
        _getNotificationRequestStatus_ oppure utilizzare la modalità push prevista dai webhook. <br/>
        <br/>
        L'unico valore ammesso per il parametro _x-pagopa-pn-cx-type_ è `PA`
      tags:
        - NewNotification
      operationId: sendNewNotification
      parameters:                                                  # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'        # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/NewNotificationRequest"
        required: true
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                 $ref: "#/components/schemas/NewNotificationResponse"
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'
    

    ###########################################################################################
    ###                        VERIFICA STATO RICHIESTE DI NOTIFICA                         ###
    ###########################################################################################
    get:
      operationId: getNotificationRequestStatus
      tags:
        - NewNotification
      summary: Verifica accettazione richiesta notifica
      description: >-
        Questa operazione serve per verificare se la richiesta di notifica è stata accettata e ottenere
        lo IUN associato a tale richiesta. <br/>
        Bisogna specificare il parametro _requestId_ oppure la coppia costituita dai parametri 
        _paNotificationId_ e _cancelledIun_. <br/>
        <br/>
        L'unico valore ammesso per il parametro _x-pagopa-pn-cx-type_ è `PA`
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/notificationRequestId'
        - $ref: '#/components/parameters/paNotificationId'
        - $ref: '#/components/parameters/cancelledIun'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                 $ref: "#/components/schemas/NewNotificationRequestStatusResponse"
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'
    
    
    ###########################################################################################
    ###                             RICERCA NOTIFICHE ACCETTATE                             ###
    ###########################################################################################
  
  "/delivery/notifications/sent/{iun}":
    get:
      summary: 'Mittente: lettura dettagli notifica'
      description: >-
        Questa operazione permette di leggere tutti i dettagli di una notifica generata da una 
        richiesta di notifica che è stata accettata. <br/>
        <br/>
        L'unico valore ammesso per il parametro _x-pagopa-pn-cx-type_ è `PA`
      tags:
        - SenderRead
      operationId: getSentNotification
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'       # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
      responses:
        '200':
          description: OK
          content:
            "*/*":
              schema:
                $ref: "#/components/schemas/FullSentNotification"
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'
    
    ###########################################################################################
    ###                     DOWNLOAD DOCUMENTI E ALLEGATI PER PAGAMENTO                     ###
    ###########################################################################################

  "/delivery/notifications/sent/{iun}/attachments/documents/{docIdx}":
    get:
      summary: Download documento notificato
      tags:
        - SenderRead
      operationId: getSentNotificationDocument
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'        # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'      # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathDocumentIdx'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification-v1.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'
        
  "/delivery/notifications/sent/{iun}/attachments/payment/{recipientIdx}/{attachmentName}":
    get:
      summary: Download allegato per pagamento
      tags:
        - SenderRead
      operationId: getSentNotificationAttachment
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathRecipientIdx'
        - $ref: '#/components/parameters/pathAttachmentName'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification-v1.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'
  
  
    ###########################################################################################
    ###                          DOWNLOAD ATTI OPPONIBILI A TERZI                           ###
    ###########################################################################################
  '/delivery-push/{iun}/legal-facts/{legalFactType}/{legalFactId}':                 # ONLY EXTERNAL
    get:                                                                            # ONLY EXTERNAL
      summary: Download atto opponibile a terzi                                     # ONLY EXTERNAL
      description: Permette di scaricare un atto opponibile a terzi                 # ONLY EXTERNAL
      tags:                                                                         # ONLY EXTERNAL
        - LegalFacts                                                                # ONLY EXTERNAL
      operationId: getLegalFact                                                     # ONLY EXTERNAL
      parameters:                                                                   # ONLY EXTERNAL
        - $ref: './parameters-notification-search-v1.yaml#/components/parameters/pathIun'                                   # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactType'                         # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactId'                           # ONLY EXTERNAL
      responses:                                                                    # ONLY EXTERNAL
        '200':                                                                      # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/json:                                                       # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: "#/components/schemas/LegalFactDownloadMetadataResponse"      # ONLY EXTERNAL
        '400':                                                                      # ONLY EXTERNAL
          description: Bad request                                                  # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/json:                                                       # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/Problem'     # ONLY EXTERNAL
components:
  
  parameters:
    ############################################################################################
    ###                     PARAMETRI DI AUTENTICAZIONE E AUTORIZZAZIONE                     ###
    ############################################################################################
    cxTypeAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxTypeAuthFleet'
    cxIdAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxIdAuthFleet'
    cxGroupsAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/cxGroupsAuthFleet'
    uidAuthFleet:
      $ref: './remote-refs.yaml#/components/parameters/uidAuthFleet'

    ############################################################################################
    ###                       PARAMETRI RICERCA RICHIESTA DI NOTIFICA                        ###
    ############################################################################################
    notificationRequestId:
      in: query
      required: false
      name: requestId
      description: identificativo della richiesta di notifica
      schema:
        type: string
    paNotificationId:
      name: paNotificationId
      in: query
      required: false
      description: >-
        Numero di protocollo associato alla notifica, può essere riutilizzato per rettifiche.
        Forma un identificativo univoco per la PA moittente se unito al parametro _cancelledIun_.
      schema:
        type: string
    cancelledIun:
      name: cancelledIun
      description: >-
        Identificativo Univoco della Notifica che deve essere rettificata, corretta.
      in: query
      required: false
      schema:
        type: string
    
    
    
    ############################################################################################
    ###                             PARAMETRI DOWNLOAD DOCUMENTI                             ###
    ############################################################################################
    pathDocumentIdx:
      name: docIdx
      in: path
      required: true
      schema:
        type: number
    pathRecipientIdx:
      name: recipientIdx
      in: path
      required: true
      schema:
        type: number
    pathAttachmentName:
      name: attachmentName
      in: path
      required: true
      schema:
        oneOf:
          - type: number
          - type: string
            enum:
              - PAGOPA
              - F24_FLAT
              - F24_DIGITAL
              - F24_DIGITAL_WITH_RS
              - F24_ANALOG_NATIONAL_1
              - F24_ANALOG_NATIONAL_2
              - F24_ANALOG_INTERNATIONAL_1
              - F24_ANALOG_INTERNATIONAL_2
    
    
    ############################################################################################
    ###                      PARAMETRI DOWNLOAD ATTI OPPONIBILI A TERZI                      ###
    ############################################################################################
    pathLegalFactType:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactType'
    pathLegalFactId:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactId'


  schemas:
    
    ###########################################################################################
    ###                             DTO PRECARICAMENTO ALLEGATI                             ###
    ###########################################################################################
    PreLoadRequest:
      title: Richiesta di precaricamento di un File
      type: object
      properties:
        requestId:
          title: Id della richiesta
          description: >-
            Identificativo univoco all'interno della request HTTP, serve per correlare la risposta. 
          type: string
        contentType:
          title: MIME type del file che verrà caricato
          description: >-
            Il MIME type dell'allegato che dovrà essere caricato. Attualmente è supportato solo
              - application/pdf
          type: string
          
    PreLoadResponse:
      title: Informazioni utili al caricamento file
      description: >-
        Per ogni richiesta che è stata fatta viene fornito un presigned URL e le 
        informazioni per usarlo.
      type: object
      properties:
        requestId:
          description: per correlazione con la richiesta
          type: string
        secret:
          description: >-
            __discutibile__ Token aggiuntivo per far si che sia necessario intercettare anche gli 
            header e non solo l'URL di upload del contenuto del documento.
          example: AZ23RF12
          type: string
        httpMethod:
          description: >-
            Indica se per l'upload del contenuto file bisogna utilizzare il metodo PUT o POST
          type: string
          enum:
            - POST
            - PUT
        url:
          description: >-
            URL a cui effettuare l'upload del contenuto del documento.
          example: 'https://preloadpn.aws.amazon.......'
          type: string
        key:
          description: >-
            la chiave restituita deve essere globalmente unica per installazione di SafeStorage e 
            persistente attraverso i processi di disaster recovery.
          example: '8F7E/9A3B/1234/AB87'
          type: string
    

    ###########################################################################################
    ###                              DTO RICHIESTE DI NOTIFICA                              ###
    ###########################################################################################

    NewNotificationResponse:
      title: Identificativi della richiesta di notifica
      description: >-
        Contiene le informazioni utili per identificare una richiesta di invio notifica
        che non è ancora stata accettata da Piattaforma notifiche.
      type: object
      required:
        - notificationRequestId
        - paNotificationId
      properties:
        notificationRequestId:
          type: string
          description: >-
            identificativo univoco di una richiesta di invio notifica, non è lo IUN
        paNotificationId:
          type: string
          description: Identificativo inviato dalla pubblica amministrazione
        cancelledIun:
          $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/IUN"
          description: >-
            Identificativo della notifica invalidata, costituisce chiave univoca se associato al 
            campo _paNotificationId_
    
    NewNotificationRequestStatusResponse:
      allOf: 
        - $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/NewNotificationRequest"
        - type: object
          required:
            - notificationRequestId
            - notificationRequestStatus
          properties:
            notificationRequestId: 
              description: >-
                identificativo univoco di una richiesta di invio notifica, non è lo IUN
              type: string
            notificationRequestStatus:
              description: >-
                - __WAITING__: in attesa di essere valutata
                - __ACCEPTED__: richiesta di notifica accettata, lo IUN è valorizzato
                - __REFUSED__: richiesta di notifica rifiutata, è valorizzato il campo _errors_
              type: string
            retryAfter:
              type: number
              description: >-
                Numero di secondi da attendere prima di effettuare una nuova richiesta per 
                la stessa entità; valorizzato quando lo status è _WARNING_.
            iun:
              $ref: "./schemas-pn-notification-v1.yaml#/components/schemas/IUN"
            errors:
              description: >-
                Elenco degli errori che hanno causato il rifiuto della richiesta di notifica
              type: array
              items:
                $ref: './schemas-pn-errors-v1.yaml#/components/schemas/ProblemError'


    ###########################################################################################
    ###                              DTO NOTIFICA CON DETTAGLI                              ###
    ###########################################################################################

    FullSentNotification:
      description: >-
        Le informazioni riguardanti una richiesta di notifica accettata e il processo di 
        inoltro della notifica verso il cittadino.
      allOf: 
        - $ref: './schemas-pn-notification-v1.yaml#/components/schemas/SentNotification'
        - type: object
          required: 
            - notificationStatus
            - notificationStatusHistory
            - timeline
          properties:  
            notificationStatus:
              $ref: '#/components/schemas/NotificationStatus'
            notificationStatusHistory:
              $ref: '#/components/schemas/NotificationStatusHistory'
            timeline:
              description: >-
                elenco dettagliato di tutto ciò che è accaduto durrante il processo di notifica
              type: array
              items:
                $ref: '#/components/schemas/TimelineElement'
    
    TimelineElement:
      $ref: './remote-refs.yaml#/components/schemas/TimelineElement'
    NotificationStatus:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatus'
    NotificationStatusHistory:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatusHistory'
    LegalFactDownloadMetadataResponse:
      $ref: './remote-refs.yaml#/components/schemas/LegalFactDownloadMetadataResponse'

   
#  securitySchemes:        # ONLY EXTERNAL
#    ApiKeyAuth:           # ONLY EXTERNAL
#      type: apiKey        # ONLY EXTERNAL
#      in: header          # ONLY EXTERNAL
#      name: x-api-key     # ONLY EXTERNAL

#security:                 # ONLY EXTERNAL
#  - ApiKeyAuth: [] # use the same name as under securitySchemes    # ONLY EXTERNAL
              


  
