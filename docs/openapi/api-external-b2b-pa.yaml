# di seguito le variabili che possono subire variazioni in caso di modifiche all'applicazione, da ricercare in base all'ID
# <span id="pnTemporaryDocument">7 giorni</span> configurazione per file temporanei caricati prima dell'inserimento notifica, definito in storageConfigurations name: PN_TEMPORARY_DOCUMENT in pn-safestorage-v1-api.yaml
# <span id="numberOfPresignedRequest">15</span> pn.delivery.number-of-presigned-request=15 numero di maxItems della preloadRequest
openapi: 3.0.3
info:
  termsOfService: https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html
  x-api-id: api-external-b2b-pa # ONLY EXTERNAL
  title: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  x-summary: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  version: '1.0.0'
  description: >-
  
    ## Abstract
      API utilizzate dalle pubbliche amministrazioni per __inviare richieste di notifiche__ e 
      __ottenere informazioni in modalità pull__ sullo stato della 
      _"richiesta di notifica"_ (accettata o rifiutata) e, in caso di richiesta accettata, 
      sulle comunicazioni effettuate, o solo tentate, nei confronti dei destinatari della notifica.
    
    ## Operazioni utilizzate, in sequenza temporale
    
    <table>

    <tr>
    
    <td>
    
     >>>>> <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="515" height="790"><desc>title%20Invio%20notifica%0Aparticipant%20PA%0Aparticipant%20PN%0Aparticipant%20PN%20Safe-Storage%0APA-%3EPN%3ApresignedUploadRequest%20(1.a)%0APN-%3EPA%3Apresigned%20urls%20%5B%20%5D%20(1.a)%0Aspace%0Aspace%0Aloop%20upload%0APA-%3EPN%20Safe-Storage%3AattachmentUpload%20(1.b)%0APN%20Safe-Storage-%3EPA%3Aresult%20(1.b)%0Aend%0Aspace%0Aspace%0Aspace%0APA-%3EPN%3AsendNewNotification%20(2)%0APN-%3EPA%3AreqId%20(2)%0Aspace%0Aspace%0A</desc><defs/><g><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="515" height="790"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="196.56147636988732" y="24.50280495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Invio notifica</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 95.887643371 L 73.50841485 790.133783621" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 316.7324396493489 95.887643371 L 316.7324396493489 790.133783621" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 434.10914269189186 95.887643371 L 434.10914269189186 790.133783621" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 46.550649445281245 51.782594461 L 100.46618025471875 51.782594461 L 100.46618025471875 95.887643371 L 46.550649445281245 95.887643371 L 46.550649445281245 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="64.27434502578124" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 288.82621080468874 51.782594461 L 344.63866849400904 51.782594461 L 344.63866849400904 95.887643371 L 288.82621080468874 95.887643371 L 288.82621080468874 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="306.54990638518876" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 360.973871794009 51.782594461 L 507.2444135897747 51.782594461 L 507.2444135897747 95.887643371 L 360.973871794009 95.887643371 L 360.973871794009 51.782594461 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="378.69756737450905" y="79.55244007099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN Safe-Storage</text></g></g><g><g><g><rect fill="white" stroke="none" x="92.83840542166662" y="128.558049971" width="204.56404365601563" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="95.28868591666662" y="143.259732941" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presignedUploadRequest (1.a)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 149.793814261 L 303.28312226568227 149.793814261" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(316.7324396493489,149.793814261) translate(-316.7324396493489,-149.793814261)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 303.11977023268224 142.98747955266666 L 316.7324396493489 149.793814261 L 303.11977023268224 156.60014896933333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="121.37455349295568" y="174.296619211" width="147.4917475134375" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="123.82483398795569" y="188.99830218099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">presigned urls [ ] (1.a)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 316.7324396493489 195.532383501 L 86.95773223366666 195.532383501" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(73.50841485,195.532383501) translate(-73.50841485,-195.532383501)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 87.12108426666666 188.72604879266666 L 73.50841485 195.532383501 L 87.12108426666666 202.33871820933334 Z"/></g></g><g><g><rect fill="white" stroke="none" x="174.75866764850454" y="345.81625386099995" width="158.10022224488281" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="177.20894814350453" y="360.51793683099993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">attachmentUpload (1.b)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 367.05201815099997 L 420.6598253082252 367.05201815099997" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(434.10914269189186,367.05201815099997) translate(-434.10914269189186,-367.05201815099997)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 420.4964732752252 360.24568344266663 L 434.10914269189186 367.05201815099997 L 420.4964732752252 373.8583528593333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="216.3263098604186" y="391.55482310099995" width="74.96493782105469" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="218.7765903554186" y="406.25650607099993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">result (1.b)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 434.10914269189186 412.790587391 L 86.95773223366666 412.790587391" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(73.50841485,412.790587391) translate(-73.50841485,-412.790587391)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 87.12108426666666 405.98425268266664 L 73.50841485 412.790587391 L 87.12108426666666 419.5969220993333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="114.85700588553381" y="584.310222041" width="160.52684272828125" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="117.30728638053381" y="599.011905011" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">sendNewNotification (2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.50841485 605.545986331 L 303.28312226568227 605.545986331" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(316.7324396493489,605.545986331) translate(-316.7324396493489,-605.545986331)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 303.11977023268224 598.7396516226667 L 316.7324396493489 605.545986331 L 303.11977023268224 612.3523210393333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="164.96794491141273" y="630.0487912809999" width="60.30496467652344" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="167.41822540641272" y="644.7504742509999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">reqId (2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 316.7324396493489 651.2845555709999 L 86.95773223366666 651.2845555709999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(73.50841485,651.2845555709999) translate(-73.50841485,-651.2845555709999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 87.12108426666666 644.4782208626666 L 73.50841485 651.2845555709999 L 87.12108426666666 658.0908902793333 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203299999996 301.71120495099996 L 491.2823542418919 301.71120495099996 L 491.2823542418919 437.29339234099996 L 16.335203299999996 437.29339234099996 L 16.335203299999996 301.71120495099996 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 16.335203299999996 301.71120495099996 L 16.335203299999996 321.31344891099997 L 73.76000443125 321.31344891099997 L 83.56112641125 311.51232693099996 L 83.56112641125 301.71120495099996 L 16.335203299999996 301.71120495099996" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="32.67040659999999" y="314.779367591" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">loop</text><g><rect fill="white" stroke="none" x="97.44604921625" y="303.018021215" width="51.15611518921875" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="99.89632971125" y="314.779367591" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[upload]</text></g></g><g/><g/><g/></g></svg>   
      
      </br>
      </br>
      </br>
      
      #### 3. Verifica accettazione richiesta di invio notifica
    
      Per questa verifica possono essere utilizzate due modalità:
      
      1. __richiesta puntale__: consigliato solo ai fini di test
      2. __lettura da stream configurato__: consigliato per ambienti di produzione
      
      La differenza tra le due modalità è nell'interazione e nell'efficienza.
      
      Con la modalità _"richiesta puntuale"_ è necessario l'invocazione per ogni notifica,
      mentre con la modalità _"stream"_ è possibile avere gli aggiornamenti
      di stato di più notifiche con una sola invocazione.
      
      #### 3.1 Richiesta puntuale di verifica accettazione
    
      Questa modalità è resa disponibile solo ai fini di test o di eventuali operazioni
      di allineamento poiché richiede l'invio di una richiesta per ogni notifica.
      Se il passo (2) avviene con successo si utilizza l'operazione 
      [getNotificationRequestStatus](#/SenderReadB2B/getNotificationRequestStatus)
      per ottenere informazioni riguardo allo stato della "richiesta di invio di notifica". </br>
      Nel campo _notificationRequestStatus_ sarà indicato:</br>
      >\- <strong>WAITING:</strong> se la validazione è ancora in corso.</br>
      \- <strong>ACCEPTED:</strong> se richiesta di notifica accettata, lo _IUN_ è valorizzato.</br>
      \- <strong>REFUSED:</strong> se richiesta di notifica rifiutata, è valorizzato il campo _errors_.</br>
      </br>
      </br>
      </br>

      #### 3.2 Richiesta avanzamento via "stream" di verifica di accettazione
    
      Questa modalità è consigliata. Per essere fruita è necessaria un'operazione preliminare 
      tramite la chiamata alla API [createEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload:</br></br>``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS",
        "filterValues": [
          "ACCEPTED"
        ]
      }
      ``</br></br>
      Successivamente si possono ottenere i dati richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Events/consumeEventStream)
      
      
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.
      
      </br>
      </br>
      </br>
      </br>
      
    </td>
    
    <td>
    
      ### Ciclo di vita della notifica lato mittente
      
      #### 1. Caricamento dei documenti della notifica
      
      Prima di invocare la richiesta di notifica è necessario caricare i documenti della notifica (documenti e bollettini di pagamento).
      
      #### 1.a. Richiesta presigned Url
      
      Invocare l'operazione [presignedUploadRequest](#/NewNotification/presignedUploadRequest) 
      con cui prenotare il caricamento. Possono essere effettuate un massimo di <span id="numberOfPresignedRequest">15</span> prenotazioni di caricamento
      per ogni richiesta.</br>
      In risposta si ottengono le seguenti informazioni:<br/>
      \- httpMethod <br/>
      \- secret <br/>
      \- url <br/>
      L'url restituito ha una validità di 1h.
      
      </br>

      #### 1.b Upload documenti della notifica
      
      Per ogni documento utilizzare un richiesta HTTP con metodo _httpMethod_ (POST o PUT) 
      all'url indicato dal campo _url_. <br/>
      In tale richiesta vanno aggiunti i seguenti header: <br/>
      \- _content-type_: valorizzato come il campo "contentType" della richiesta di cui al punto (1.a) <br/>
      \- _x-amz-meta-secret_: valorizzato con il valore del campo "secret" della risposta di cui al punto (1.a) <br/>
      \- _trailer_: valorizzato con ```x-amz-checksum-sha256``` <br/>
      \- _x-amz-checksum-sha256_: valorizzato con il checksum sha256, codificato in base 64, del contenuto binario del file che verrà caricato. (__N.B.__ questo è un trailer HTTP non un header).
        Vedi [HTTP Trailer](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Trailer) <br/>
        __NOTA:__ se l'operazione di upload è stata eseguita con successo, si otterrà come risposta _status 200 OK_. <br/>
        Nell'header di questa risposta, si otterrà il campo __x-amz-version-id__ che dovrà essere utilizzato durante <br/> 
        l'inserimento della notifica, nel campo ref.__versionToken__ in corrispondenza del documento ad esso associato.
  
     
      </br>
      </br>
      </br>
      
      #### 2. Richiesta di invio della notifica
    
      Per effettuare una richiesta di invio notifica, invocare l'operazione 
      [sendNewNotification](#/NewNotification/sendNewNotification) utilizzando i riferimenti dei file 
      caricati ottenuti al punto (1.b).
      
      </br>
      </br>
      </br>
      </br>
      </br>
      </br>
      </br>
            
    >>><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="489" height="731"><desc>alt%20single%20request%20check%0Anote%20over%20PA%2CPN%3AOnly%20for%20test%20purpose%0Aspace%0Aspace%0Aloop%20check%0APA-%3EPN%3AgetNotificationRequestStatus(reqId)%20(3.1)%0APN%20-%3EPA%3AIUN%20(3.1)%0Aend%0Aspace%0Aelse%20Stream%20solution%0Anote%20over%20PA%2CPN%3ASee%20%3Clink%3Ahttps%3A%2F%2Fpetstore.swagger.io%2F%3Furl%3Dhttps%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml%3EAPI%20B2B%20avanzamento%20notifiche%3C%2Flink%3E%0APA-%3EPN%3AgetEvents(Stream)%20(3.2)%0APN-%3EPA%3Aevents%20%5B%20%5D%20(3.2)%0Aend</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="489" height="731"/></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 55.049635120999994 L 89.84361815 731.3270517409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 55.049635120999994 L 399.86073376966146 731.3270517409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray="12.565541,5.445067766666667"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 62.88585274528125 10.944586211000003 L 116.80138355471874 10.944586211000003 L 116.80138355471874 55.049635120999994 L 62.88585274528125 55.049635120999994 L 62.88585274528125 10.944586211000003 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="80.60954832578125" y="38.71443182099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PA</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 371.9545049250013 10.944586211000003 L 427.7669626143216 10.944586211000003 L 427.7669626143216 55.049635120999994 L 371.9545049250013 55.049635120999994 L 371.9545049250013 10.944586211000003 Z" stroke-miterlimit="10" stroke-width="2.613632528" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="389.6782005055013" y="38.71443182099999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">PN</text></g></g><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 75.14193517999999 131.82509063099997 L 399.86073376966146 131.82509063099997 L 414.56241673966144 146.52677360099997 L 414.56241673966144 169.39605822099998 L 75.14193517999999 169.39605822099998 L 75.14193517999999 131.82509063099997 M 399.86073376966146 131.82509063099997 L 399.86073376966146 146.52677360099997 L 414.56241673966144 146.52677360099997" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="176.813548335319" y="154.69437525099994" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Only for test purpose</text></g><g><g><rect fill="white" stroke="none" x="109.17360872166667" y="319.67992858099996" width="271.3571344763281" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="111.62388921666667" y="334.38161155099993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">getNotificationRequestStatus(reqId) (3.1)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 340.915692871 L 386.4114163859948 340.915692871" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(399.86073376966146,340.915692871) translate(-399.86073376966146,-340.915692871)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 386.2480643529948 334.10935816266664 L 399.86073376966146 340.915692871 L 386.2480643529948 347.7220275793333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="212.67033571141278" y="365.41849782099996" width="64.36368049683594" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="215.12061620641276" y="380.12018079099994" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IUN (3.1)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 386.654262111 L 103.29293553366666 386.654262111" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(89.84361815,386.654262111) translate(-89.84361815,-386.654262111)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 103.45628756666666 379.84792740266664 L 89.84361815 386.654262111 L 103.45628756666666 393.4605968193333 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 75.14193517999999 520.6029291709999 L 399.86073376966146 520.6029291709999 L 414.56241673966144 535.3046121409999 L 414.56241673966144 558.1738967609999 L 75.14193517999999 558.1738967609999 L 75.14193517999999 520.6029291709999 M 399.86073376966146 520.6029291709999 L 399.86073376966146 535.3046121409999 L 414.56241673966144 535.3046121409999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="126.68471837926432" y="543.472213791" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">See </text><a xlink:href="https://petstore.swagger.io/?url=https://raw.githubusercontent.com/pagopa/pn-delivery-push/develop/docs/openapi/api-external-b2b-webhook.yaml"><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="underline" x="156.84218908238932" y="543.472213791" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">API B2B avanzamento notifiche</text></a></g><g><g><rect fill="white" stroke="none" x="164.18790620701824" y="582.6767017109999" width="161.328539505625" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="166.63818670201823" y="597.3783846809998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">getEvents(Stream) (3.2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 89.84361815 603.9124660009999 L 386.4114163859948 603.9124660009999" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(399.86073376966146,603.9124660009999) translate(-399.86073376966146,-603.9124660009999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 386.2480643529948 597.1061312926665 L 399.86073376966146 603.9124660009999 L 386.2480643529948 610.7188007093332 Z"/></g></g><g><g><rect fill="white" stroke="none" x="195.55152315037762" y="628.4152709509998" width="98.60130561890625" height="21.23576429"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="198.0018036453776" y="643.1169539209998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">events [ ] (3.2)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 399.86073376966146 649.6510352409998 L 103.29293553366666 649.6510352409998" stroke-miterlimit="10" stroke-width="1.3612669416666667" stroke-dasharray=""/><g transform="translate(89.84361815,649.6510352409998) translate(-89.84361815,-649.6510352409998)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 103.45628756666666 642.8447005326665 L 89.84361815 649.6510352409998 L 103.45628756666666 656.4573699493332 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 87.72004172099999 L 473.3691486196615 87.72004172099999 L 473.3691486196615 674.1538401909999 L 16.335203300000003 674.1538401909999 L 16.335203300000003 87.72004172099999 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 87.72004172099999 L 16.335203300000003 107.32228568099998 L 62.694406897070316 107.32228568099998 L 72.49552887707031 97.52116370099999 L 72.49552887707031 87.72004172099999 L 16.335203300000003 87.72004172099999" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="32.67040660000001" y="100.78820436099998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><g><rect fill="white" stroke="none" x="86.38045168207032" y="89.02685798499998" width="128.75847114625" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="88.83073217707032" y="100.78820436099998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[single request check]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 16.335203300000003 476.4978802609999 L 473.3691486196615 476.4978802609999" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray="4.083800825"/></g><g/><g><rect fill="white" stroke="none" x="86.38045168207032" y="477.80469652499994" width="101.35219062867188" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="88.83073217707032" y="489.56604290099995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Stream solution]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 32.6704066 275.57487967099996 L 457.0339453196615 275.57487967099996 L 457.0339453196615 411.15706706099996 L 32.6704066 411.15706706099996 L 32.6704066 275.57487967099996 Z" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 32.6704066 275.57487967099996 L 32.6704066 295.177123631 L 90.09520773125 295.177123631 L 99.89632971125 285.37600165099997 L 99.89632971125 275.57487967099996 L 32.6704066 275.57487967099996" stroke-miterlimit="10" stroke-width="2.3336004714285714" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="49.005609899999996" y="288.643042311" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">loop</text><g><rect fill="white" stroke="none" x="113.78125251625" y="276.881695935" width="45.972719803476565" height="16.988611432000003"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8.8pt" font-style="normal" font-weight="bold" text-decoration="normal" x="116.23153301125001" y="288.643042311" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[check]</text></g><g/></g><g/><g/></g></svg>
    </td>
      
    </tr>
    
    </table>
    
    
      ### 4. Monitorare l'avanzamento di una notifica
    
      Allo stesso modo del monitoraggio dell'accettazione della notifica da parte della Piattaforma sono 
      disponibili le due modalità.
      
      #### 4.1 Monitoraggio puntuale
    
      Se la "richiesta di invio di notifica" passa le validazioni viene trasformata in "notifica" e sarà 
      identificata dalla IUN restituito dall'operazione 
      [getNotificationRequestStatus](#/SenderReadB2B/getNotificationRequestStatus).</br> 
      A tal punto si potranno utilizzare l'operazione _GET /delivery/notifications/sent/{iun}_ per 
      ottenere i dettagli della notifica, la _timeline_ che dettaglia il perfezionamento della
      notifica per il mittente e l'avanzamento delle comunicazioni nei confronti dei destinatari.
      
      #### 4.1 Monitoraggio tramite stream
    
      Questa modalità è consigliata in produzione. Per essere fruita è necessaria una operazione preliminare
      tramite la chiamata alla API [createEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload di esempio:</br></br>``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS"
      }
      ``</br></br>che permette di monitorare gli eventi di tipo "STATO". Successivamente si può ottenere il dettaglio della stream appena creata chiamando la 
      API [getEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Streams/getEventStream), mentre si possono ottenere i dati degli eventi richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Events/consumeEventStream)
  
  
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.

      </br>

      ### 5. Download dei Legal Facts

      E' possibile scaricare le Attestazioni Opponibili a Terzi e gli altri documenti conservati da Piattaforma Notifiche attraverso il servizio di [dowload Legal Fact](#/SenderReadB2B/getSentNotificationDocument) passando all'interno del path lo <strong>Iun</strong>, il <strong>legalFactType</strong> ed il <strong>legalFactId</strong>; si otterrà nella response un link che permette di scaricare il documento richiesto.</br> Per ottenere il <strong>legalFactType</strong> ed il <strong>legalFactId</strong> bisogna chiamare il servizio di [lettura dettaglio notifica](#/SenderReadB2B/getSentNotification) con lo <code>{Iun}</code> della notifica di interesse: all'interno del campo <i>timeline</i> della response è possibile trovare l'elenco degli eventi di quella notifica ed i <strong>legalFactType</strong> e <strong>legalFactId</strong> in corrispondenza degli eventi che generano documenti.
      
    </br>
    <h3>Le FAQ possono essere consultate al seguente link:
    <a href="https://docs.pagopa.it/v1.0-1/">https://docs.pagopa.it/v1.0-1/</a></h3>
    
    <details>
      <summary><strong><big><big><big><big>AMBIENTI</big></big></big></big></strong></summary>
    <ul>  
    <li><strong>https://api.pn.pagopa.it:</strong></br>Ambiente di produzione</li>
    <li><strong>https://api.coll.pagopa.it:</strong></br>Ambiente di collaudo</li>
    <li><strong>https://api.svil.pn.pagopa.it:</strong></br>Ambiente di test. Potrebbe subire modifiche/integrazioni in futuro, rimanendo comunque non-bloccante e rispettando il principio di retro-attività</li>
    <li><strong>https://api.dev.pn.pagopa.it:</strong></br>Ambiente di sviluppo</li>
    </ul>  
    </details></br>
      
  contact:
    email: pn-supporto-enti@pagopa.it
  license:
    name: Licenza di PN
    url: 'https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html'
servers:
  - url: https://api.pn.pagopa.it
    description: Ambiente di produzione
  - url: https://api.coll.pn.pagopa.it
    description: Ambiente di collaudo
  - url: https://api.svil.pn.pagopa.it
    description: Ambiente di test
  - url: https://api.dev.pn.pagopa.it
    description: Ambiente di sviluppo
tags:
  - name: HealthCheck
    description: >-
      Invocazioni per sapere lo stato di Piattaforma Notifiche # il servizio è ancora in fase di sviluppo
  - name: NewNotification
    description: >-
      Invocazioni per effettuare il pre-caricamento dei documenti della notifica e inviare notifiche
  - name: SenderReadB2B
    description: >-
      Invocazioni utilizzabili dai mittenti per verificare lo stato delle richieste 
      di notifica inviate e delle notifiche accettate.
  - name: NotificationPrice
    description: >-
      Invocazioni per determinare il costo della notifica per il destinario.
  - name: LegalFacts
    description: >-
      Invocazioni per effettuare il downalod degli atti opponibili a terzi
  - name: PaymentEvents
    description: >-
      Invocazioni per comunicare eventi di pagamento dalla PA

paths:
  ###########################################################################################
  ###                          STATUS PIATTAFORMA NOTIFICHE                               ###
  ###########################################################################################
  "/status":
    get:
      summary: status path
      description: status path per verificare lo stato di Piattaforma Notifiche
      tags:
        - HealthCheck
      operationId: status
      responses:
        '200':
          description: Ok
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/PnStatusResponse"
              example:
                functionalities: [NOTIFICATION_CREATE,NOTIFICATION_VISUALIZATION,NOTIFICATION_WORKFLOW]
                openIncidents: []
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/PnStatusResponse"
              example:
                functionalities: [NOTIFICATION_CREATE,NOTIFICATION_VISUALIZATION,NOTIFICATION_WORKFLOW]
                openIncidents:
                  - functionality: NOTIFICATION_CREATE
                    status: KO
                    startDate: "2019-08-24T14:15:22Z"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  ###########################################################################################
  ###                          GESTIONE PRECARICAMENTO ALLEGATI                           ###
  ###########################################################################################
  "/delivery/attachments/preload":
    post:
      summary: Richiesta di pre-caricamento dei documenti della notifica
      description: >-
        Operazione che richiede a Piattaforma Notifica le informazioni e le autorizzazioni necessarie 
        a precaricare uno o più file da allegare a una notifica. <br/>

      tags:
        - NewNotification
      operationId: presignedUploadRequest
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/PreLoadRequest"
              minItems: 1
              maxItems: 15
        required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PreLoadResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

    ###########################################################################################
    ###                          CREAZIONE RICHIESTE DI NOTIFICA                           ###
    ###########################################################################################

  "/delivery/requests":
    post:
      summary: Richiesta invio notifica
      description: |-
        Operazione utilizzata dalla Pubblica Amministrazione per richiedere l'invio di una notifica.

        La restituzione di uno stato HTTP 202 significa solo che la richiesta è sintatticamente
        valida, non che la richiesta sia stata validata ed accettata. <br/>
        Per conoscere lo stato di accettazione della richiesta di notifica bisogna utilizzare l'operazione
        _getNotificationRequestStatus_ oppure utilizzare la modalità push prevista dai webhook. <br/>
        
      tags:
        - NewNotification
      operationId: sendNewNotification
      requestBody:
        content:
          application/json:
            schema:
              $ref: "./schemas-pn-notification.yaml#/components/schemas/NewNotificationRequest"
        required: true
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '409':
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    

    ###########################################################################################
    ###                        VERIFICA STATO RICHIESTE DI NOTIFICA                         ###
    ###########################################################################################
    get:
      operationId: retrieveNotificationRequestStatus                 # ONLY EXTERNAL
      tags:
        - SenderReadB2B
      summary: Verifica accettazione richiesta notifica
      description: >-
        Questa operazione serve per verificare se la richiesta di notifica è stata accettata e ottenere
        lo IUN associato a tale richiesta. <br/>
        Bisogna specificare il parametro _requestId_ oppure la coppia costituita dai parametri 
        _paProtocolNumber_ e _idempotenceToken_. <br/>
      parameters:
        - $ref: '#/components/parameters/notificationRequestId'
        - $ref: '#/components/parameters/paProtocolNumber'
        - $ref: '#/components/parameters/idempotenceToken'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationRequestStatusResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    
    
    ###########################################################################################
    ###                             RICERCA NOTIFICHE ACCETTATE                             ###
    ###########################################################################################
  
  "/delivery/notifications/sent/{iun}":
    get:
      summary: 'Mittente: lettura dettagli notifica'
      description: |-
        Questa operazione permette di leggere tutti i dettagli di una notifica accettata. <br/>

      tags:
        - SenderReadB2B
      operationId: retrieveSentNotification                                # ONLY EXTERNAL
      parameters:
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
      responses:
        '200':
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/FullSentNotification"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    
    ###########################################################################################
    ###                     DOWNLOAD DOCUMENTI E ALLEGATI PER PAGAMENTO                     ###
    ###########################################################################################

  "/delivery/notifications/sent/{iun}/attachments/documents/{docIdx}":
    get:
      description: |-
        Download documento notificato

      summary: Download documento notificato
      tags:
        - SenderReadB2B
      operationId: retrieveSentNotificationDocument                                # ONLY EXTERNAL
      parameters:
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathDocumentIdx'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem' 
                
  "/delivery/notifications/sent/{iun}/attachments/payment/{recipientIdx}/{attachmentName}":
    get:
      description: Download allegato per pagamento
      summary: Download allegato per pagamento
      tags:
        - SenderReadB2B
      operationId: retrieveSentNotificationAttachment                                # ONLY EXTERNAL
      parameters:
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathRecipientIdx'
        - $ref: '#/components/parameters/pathAttachmentName'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem' 

    ###########################################################################################
    ###                          DOWNLOAD ATTI OPPONIBILI A TERZI                           ###
    ###########################################################################################
  '/delivery-push/{iun}/legal-facts/{legalFactType}/{legalFactId}':                 # ONLY EXTERNAL
    get:                                                                            # ONLY EXTERNAL
      summary: Download atto opponibile a terzi                                     # ONLY EXTERNAL
      description: Permette di scaricare un atto opponibile a terzi                 # ONLY EXTERNAL
      tags:                                                                         # ONLY EXTERNAL
        - LegalFacts                                                                # ONLY EXTERNAL
      operationId: retrieveLegalFact                                               # ONLY EXTERNAL
      parameters:                                                                   # ONLY EXTERNAL
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun' # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactType'                         # ONLY EXTERNAL
        - $ref: '#/components/parameters/pathLegalFactId'                           # ONLY EXTERNAL
      responses:                                                                    # ONLY EXTERNAL
        '200':                                                                      # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/json:                                                       # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: "#/components/schemas/LegalFactDownloadMetadataResponse"      # ONLY EXTERNAL
        '400':                                                                      # ONLY EXTERNAL
          description: Bad request                                                  # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '500':                                                                      # ONLY EXTERNAL
          description: Internal error                                               # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
  '/delivery/price/{paTaxId}/{noticeCode}':                                         # ONLY EXTERNAL
    get:                                                                            # ONLY EXTERNAL
      operationId: retrieveNotificationPrice                                       # ONLY EXTERNAL
      summary: Retrieve notification price and effective date                       # ONLY EXTERNAL
      description: >-                                                               # ONLY EXTERNAL
        Usata dalla PA per recuperare il costo di notificazione tramite
         l'identificativo della posizione debitoria paTaxId e noticeCode.
      tags:                                                                         # ONLY EXTERNAL
        - NotificationPrice                                                         # ONLY EXTERNAL
      parameters:                                                                   # ONLY EXTERNAL
        - name: paTaxId                                                             # ONLY EXTERNAL
          description: Payment PA fiscal code                                       # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '77777777777'                                                    # ONLY EXTERNAL
          schema:                                                                   # ONLY EXTERNAL
            $ref: 'schemas-pn-notification.yaml#/components/schemas/paTaxId'        # ONLY EXTERNAL
        - name: noticeCode                                                          # ONLY EXTERNAL
          description: Payment notice number  numero avviso                         # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '302000100000019421'                                             # ONLY EXTERNAL
          schema:                                                                   # ONLY EXTERNAL
            $ref: 'schemas-pn-notification.yaml#/components/schemas/noticeCode'     # ONLY EXTERNAL
      responses:                                                                    # ONLY EXTERNAL
        '200':                                                                      # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/json:                                                       # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/NotificationPriceResponse'              # ONLY EXTERNAL
        '400':                                                                      # ONLY EXTERNAL
          description: Invalid input                                                # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '404':                                                                      # ONLY EXTERNAL
          description: Not Found                                                    # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '500':                                                                      # ONLY EXTERNAL
          description: Internal Server Error                                        # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL

    ###########################################################################################
    ###                     RICEZIONE DATI AVVENUTO PAGAMENTO DALLA PA                      ###
    ###########################################################################################
  '/delivery/events/payment/pagopa':
    post:
      operationId: paymentEventsRequestPagoPa
      description: >-
        Questa API è a disposizione della Pubblica Amministrazione per inviare eventi
        di chiusura di una o più posizioni debitorie di tipo PagoPA. <br/>
      tags:
        - PaymentEvents
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/PaymentEventsRequestPagoPa"
      responses:
        '204':
          description: OK
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  '/delivery/events/payment/f24':
    post:
      operationId: paymentEventsRequestF24
      description: >-
        Questa API è a disposizione della Pubblica Amministrazione per inviare eventi
        di chiusura di una o più posizioni debitorie di tipo F24. <br/>
      tags:
        - PaymentEvents
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/PaymentEventsRequestF24"
      responses:
        '204':
          description: OK
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

components:
  
  parameters:
    ############################################################################################
    ###                     PARAMETRO SORGENTE CREAZIONE NOTIFICA                            ###
    ############################################################################################
     
    ############################################################################################
    ###                     PARAMETRI DI AUTENTICAZIONE E AUTORIZZAZIONE                     ###
    ############################################################################################

    ############################################################################################
    ###                       PARAMETRI RICERCA RICHIESTA DI NOTIFICA                        ###
    ############################################################################################
    notificationRequestId:
      in: query
      required: false
      name: notificationRequestId
      description: identificativo della richiesta di notifica
      schema:
        type: string
    paProtocolNumber:
      name: paProtocolNumber
      in: query
      required: false
      description: >-
        Numero di protocollo associato alla notifica, può essere riutilizzato per rettifiche.
      schema:
        type: string
        # ASCII printable characters
        pattern: ^[ -~]*$
        maxLength: 256
    idempotenceToken:
      name: idempotenceToken
      description: >-
        token usato per disambiguare "richieste di notificazione" effettuate con lo stesso 
        numero di protocollo. 
      in: query
      required: false
      schema:
        type: string
        # ASCII printable characters
        pattern: ^[ -~]*$
        maxLength: 256
    
    
    ############################################################################################
    ###                             PARAMETRI DOWNLOAD DOCUMENTI                             ###
    ############################################################################################
    pathDocumentIdx:
      name: docIdx
      description: indice del documento nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathRecipientIdx:
      name: recipientIdx
      description: indice dei destinatario nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathAttachmentName:
      name: attachmentName
      description: Tipologia del pagamento allegato alla notifica. Valori possibili PAGOPA|F24_FLAT|F24_STANDARD
      in: path
      required: true
      schema:
        type: string
        minLength: 6
        maxLength: 12
        pattern: "PAGOPA|F24_FLAT|F24_STANDARD"
        #quella sottostante è quella corretta. Riscritta per problemi con tool usato
        #oneOf:
        #  - type: number
        #  - type: string
        #    enum:
        #      - PAGOPA
        #      - F24_FLAT
        #      - F24_STANDARD
    
    
    ############################################################################################
    ###                      PARAMETRI DOWNLOAD ATTI OPPONIBILI A TERZI                      ###
    ############################################################################################
    pathLegalFactType:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactType'
    pathLegalFactId:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactId'


  schemas:
    ###########################################################################################
    ###                             DTO STATUS PN                                           ###
    ###########################################################################################
    PnStatusResponse:
      $ref: './remote-refs.yaml#/components/schemas/PnStatusResponse'
    
    ###########################################################################################
    ###                             DTO PRECARICAMENTO ALLEGATI                             ###
    ###########################################################################################
    PreLoadRequest:
      title: Richiesta di precaricamento di un File
      type: object
      required:
        - sha256
      properties:
        preloadIdx:
          title: Id della richiesta di precaricamento di un file
          description: >-
            Identificativo univoco all'interno della request HTTP, serve per correlare la risposta.
            Stringa alfanumerica con caratteri utilizzabili in un nome file.
          type: string
          minLength: 1
          maxLength: 512
          pattern: ^[a-zA-Z0-9._-]{1,512}$
        contentType:
          title: MIME type del file che verrà caricato
          description: >-
            Il MIME type dell'allegato che dovrà essere caricato. Attualmente è supportato solo
              - application/pdf
          type: string
          minLength: 15
          maxLength: 15
          pattern: ^application\/pdf
        sha256:
          title: checksum sha256 del file che verrà caricato
          description: >-
            checksum sha256, codificato in base 64, del contenuto binario del file che verrà
            caricato
          type: string
          example: 'jezIVxlG1M1woCSUngM6KipUN3/p8cG5RMIPnuEanlE='
          minLength: 43
          maxLength: 44
          pattern: ^[A-Za-z0-9+/]{43}=|[A-Za-z0-9+/]{44}$

    PreLoadResponse:
      title: Informazioni per il caricamento file
      description: >-
        Per ogni richiesta che è stata fatta viene fornito un presigned URL e le 
        informazioni per usarlo.
      type: object
      properties:
        preloadIdx:
          description: per correlazione con la richiesta. Stringa alfanumerica con caratteri utilizzabili in un file.
          type: string
          minLength: 1
          maxLength: 512
          pattern: ^[a-zA-Z0-9._-]{1,512}$
        secret:
          description: >-
            Token aggiuntivo per far si che sia necessario intercettare anche gli 
            header e non solo l'URL di upload del contenuto del documento.
          example: AZ23RF12
          type: string
        httpMethod:
          description: >-
            Indica se per l'upload del contenuto file bisogna utilizzare il metodo PUT o POST
          type: string
          example: PUT
          enum:
            - POST
            - PUT
        url:
          description: >-
            URL a cui effettuare l'upload del contenuto del documento.
          type: string
          example: 'https://preloadpn.aws.amazon.......'
        key:
          description: >-
            la chiave restituita sarà globalmente unica e andrà utilizzata nella richiesta 
            di notifica.
          example: 'PN_NOTIFICATION_ATTACHMENTS-0001-301W-B9CB-9U72-WIKD'
          type: string
    NotificationPriceResponse:
      title: Notification price Response
      description: >-
        Notification price and effective date
      type: object
      properties:
        iun:
          $ref: './schemas-pn-notification.yaml#/components/schemas/IUN'
        amount:
          description: amount in euro cents
          type: integer
          format: int32
        refinementDate:
          description: data di perfezionamento per decorrenza termini localizzata
          type: string
          format: date-time
        notificationViewDate:
          description: data di perfezionamento per presa visione
          type: string
          format: date-time

    ###########################################################################################
    ###                              DTO RICHIESTE DI NOTIFICA                              ###
    ###########################################################################################

    NewNotificationResponse:
      title: Identificativi della richiesta di notifica
      description: >-
        Contiene le informazioni per identificare una richiesta di invio notifica
        che non è ancora stata accettata da Piattaforma notifiche.
      type: object
      required:
        - notificationRequestId
        - paProtocolNumber
      properties:
        notificationRequestId:
          type: string
          description: >-
            identificativo univoco di una richiesta di invio notifica, non è lo IUN
          maxLength: 36
          pattern: ^[A-Za-z0-9+/=]{36}$
        paProtocolNumber:
          type: string
          description: Identificativo inviato dalla pubblica amministrazione
        idempotenceToken:
          description: >-
            Ripetizione del token usato per disambiguare "richieste di notificazione" 
            effettuate con lo stesso numero di protocollo (campo _paProtocolNumber_).
          type: string
    
    NewNotificationRequestStatusResponse:
      allOf:
        - $ref: "./schemas-pn-notification.yaml#/components/schemas/NewNotificationRequest"
        - type: object
          required:
            - notificationRequestId
            - notificationRequestStatus
          properties:
            notificationRequestId:
              description: >-
                identificativo univoco di una richiesta di invio notifica, non è lo IUN
              type: string
            notificationRequestStatus:
              description: >-
                - __WAITING__: in attesa di essere valutata
                - __ACCEPTED__: richiesta di notifica accettata, lo IUN è valorizzato
                - __REFUSED__: richiesta di notifica rifiutata, è valorizzato il campo _errors_
              type: string
            retryAfter:
              type: integer
              format: int32
              description: >-
                Numero di secondi da attendere prima di effettuare una nuova richiesta per 
                la stessa entità; valorizzato quando lo status è __WAITING__.
            iun:
              $ref: "./schemas-pn-notification.yaml#/components/schemas/IUN"
            errors:
              description: >-
                Elenco degli errori che hanno causato il rifiuto della richiesta di notifica
              type: array
              items:
                $ref: '#/components/schemas/ProblemError'

    Problem:
      $ref: './remote-refs.yaml#/components/schemas/Problem'
    ProblemError:
      $ref: './remote-refs.yaml#/components/schemas/ProblemError'


    ###########################################################################################
    ###                              DTO NOTIFICA CON DETTAGLI                              ###
    ###########################################################################################

    FullSentNotification:
      description: >-
        Le informazioni riguardanti una notifica (richiesta di notifica accettata) e il 
        processo di inoltro della notifica verso il cittadino.
      allOf:
        - $ref: './schemas-pn-notification.yaml#/components/schemas/SentNotification'
        - type: object
          required:
            - notificationStatus
            - notificationStatusHistory
            - timeline
          properties:
            notificationStatus:
              $ref: '#/components/schemas/NotificationStatus'
            notificationStatusHistory:
              $ref: '#/components/schemas/NotificationStatusHistory'
            timeline:
              description: >-
                elenco dettagliato di tutto ciò che è accaduto durrante il processo di notifica
              type: array
              items:
                $ref: '#/components/schemas/TimelineElement'


    ###########################################################################################
    ###                              DTO EVENTO DI PAGAMENTO                                ###
    ###########################################################################################
    
    PaymentEventsRequestPagoPa:
      title: Invio eventi di pagamento da PA a PN
      description: >- 
        Richiesta contenente un array di eventi di pagamento di tipo PagoPA di cui una Pubblica Amministrazione
        deve avvisare Piattaforma Notifiche.
      type: object
      required:
        - events
      properties:
        events:
          description: Elenco degli eventi di pagamento
          type: array
          items:
            $ref: '#/components/schemas/PaymentEventPagoPa'

    PaymentEventsRequestF24:
      title: Invio eventi di pagamento da PA a PN
      description: >- 
        Richiesta contenente un array di eventi di pagamento di tipo F24 di cui una Pubblica Amministrazione
        deve avvisare Piattaforma Notifiche.
      type: object
      required:
        - events
      properties:
        events:
          description: Elenco degli eventi di pagamento
          type: array
          items:
            $ref: '#/components/schemas/PaymentEventF24'

    #PaymentEvents:
    #  type: object
    #  oneOf:
    #    - $ref: '#/components/schemas/PaymentEventPagoPa'
    #    - $ref: '#/components/schemas/PaymentEventF24'

    PaymentEventPagoPa:
      title: Evento di pagamento PagoPa
      description: >-
        Comprende: <br/>
          - _noticeCode_: "codice avviso pagoPA" di pagamento del sistema pagoPA, usato per pagamento online.<br/>
          - _creditorTaxId_: codice fiscale dell'ente a cui fa riferimento il "codice avviso pagoPA". <br/>
          - data e ora del pagamento. <br/>
          - importo del pagamento in eurocent. <br/>
      type: object
      required:
        - noticeCode
        - creditorTaxId
        - paymentDate
        - amount
      properties:
        noticeCode:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/noticeCode'
        creditorTaxId:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/paTaxId'
        paymentDate:
          type: string
          format: date-time
        amount:
          type: integer
          format: int32

    PaymentEventF24:
      title: Evento di pagamento F24
      description: >-
        Comprende: <br/>
          - lo _IUN_ della notifica pagata, <br/>
          - data e ora del pagamento, <br/>
          - il codice fiscale del destinatario pagatore, <br/>
          - la tipologia del destinatario pagatore (PF / PG), <br/>
          - importo del pagamento in eurocent. <br/>
      type: object
      required:
        - iun
        - paymentDate
        - recipientTaxId
        - recipientType
        - amount
      properties:
        iun:
          type: string
          minLength: 25
          maxLength: 25
          pattern: ^[A-Z]{4}-[A-Z]{4}-[A-Z]{4}-[0-9]{6}-[A-Z]{1}-[0-9]{1}$
        paymentDate:
          type: string
          format: date-time
        recipientTaxId:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/TaxId'
        recipientType:
          type: string
          minLength: 2
          maxLength: 2
          pattern: "PF|PG"
        amount:
          type: integer
          format: int32
    
    TimelineElement:
      $ref: './remote-refs.yaml#/components/schemas/TimelineElement'
    NotificationStatus:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatus'
    NotificationStatusHistory:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatusHistory'
    LegalFactDownloadMetadataResponse:
      $ref: './remote-refs.yaml#/components/schemas/LegalFactDownloadMetadataResponse'

  securitySchemes:        # ONLY EXTERNAL
    ApiKeyAuth:           # ONLY EXTERNAL
      type: apiKey        # ONLY EXTERNAL
      in: header          # ONLY EXTERNAL
      name: x-api-key     # ONLY EXTERNAL

security:                 # ONLY EXTERNAL
  - ApiKeyAuth: [] # use the same name as under securitySchemes    # ONLY EXTERNAL
              


  
