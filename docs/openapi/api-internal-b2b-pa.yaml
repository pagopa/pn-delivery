# di seguito le variabili che possono subire variazioni in caso di modifiche all'applicazione, da ricercare in base all'ID
# <span id="pnTemporaryDocument">7 giorni</span> configurazione per file temporanei caricati prima dell'inserimento notifica, definito in storageConfigurations name: PN_TEMPORARY_DOCUMENT in pn-safestorage-v1-api.yaml
# <span id="numberOfPresignedRequest">15</span> pn.delivery.number-of-presigned-request=15 numero di maxItems della preloadRequest
openapi: 3.0.3
info:
  termsOfService: https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html
  x-api-id: api-internal-b2b-pa # NO EXTERNAL
#  x-api-id: api-external-b2b-pa # ONLY EXTERNAL
  title: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  x-summary: 'Piattaforma Notifiche: API B2B per le Pubbliche Amministrazioni'
  version: '1.0.0'
  description: >-
  
    ## Abstract
      API utilizzate dalle pubbliche amministrazioni per __inviare richieste di notifiche__ e 
      __ottenere informazioni in modalità pull__ sullo stato della 
      _"richiesta di notifica"_ (accettata o rifiutata) e, in caso di richiesta accettata, 
      sulle comunicazioni effettuate, o solo tentate, nei confronti dei destinatari della notifica.
    
    ## Operazioni utilizzate, in sequenza temporale
    
    <table>

    <tr>
    
    <td>
    
     <img src="https://raw.githubusercontent.com/pagopa/pn-delivery/e6f1db9eac9ace7fc2ad0fe6de241ab4525b6b6a/docs/openapi/images/invio-notifica.png" height="790" width="515" alt="Invio notifica" />

       </br>
       </br>
       </br>
      
      #### 3. Verifica accettazione richiesta di invio notifica
    
      Per questa verifica possono essere utilizzate due modalità:
      
      1. __richiesta puntale__: consigliato solo ai fini di test
      2. __lettura da stream configurato__: consigliato per ambienti di produzione
      
      La differenza tra le due modalità è nell'interazione e nell'efficienza.
      
      Con la modalità _"richiesta puntuale"_ è necessario l'invocazione per ogni notifica,
      mentre con la modalità _"stream"_ è possibile avere gli aggiornamenti
      di stato di più notifiche con una sola invocazione.
      
      #### 3.1 Richiesta puntuale di verifica accettazione
    
      Questa modalità è resa disponibile solo ai fini di test o di eventuali operazioni
      di allineamento poiché richiede l'invio di una richiesta per ogni notifica.
      Se il passo (2) avviene con successo si utilizza l'operazione 
      [getNotificationRequestStatus](#/SenderReadB2B/getNotificationRequestStatusV21)
      per ottenere informazioni riguardo allo stato della "richiesta di invio di notifica". </br>
      Nel campo _notificationRequestStatus_ sarà indicato:</br>
      >\- <strong>WAITING:</strong> se la validazione è ancora in corso.</br>
      \- <strong>ACCEPTED:</strong> se richiesta di notifica accettata, lo _IUN_ è valorizzato.</br>
      \- <strong>REFUSED:</strong> se richiesta di notifica rifiutata, è valorizzato il campo _errors_.</br>
      </br>
      </br>
      </br>

      #### 3.2 Richiesta avanzamento via "stream" di verifica di accettazione
    
      Questa modalità è consigliata. Per essere fruita è necessaria un'operazione preliminare 
      tramite la chiamata alla API [createEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload:</br></br>``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS",
        "filterValues": [
          "ACCEPTED"
        ]
      }
      ``</br></br>
      Successivamente si possono ottenere i dati richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Events/consumeEventStream)
      
      
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.
      
      </br>
      </br>
      </br>
      </br>
      
    </td>
    
    <td>
    
      ### Ciclo di vita della notifica lato mittente
      
      #### 1. Caricamento dei documenti della notifica
    
      Prima di invocare la richiesta di notifica è necessario caricare i documenti della notifica (documenti e bollettini/metadati di pagamento).
      [Schema Metadata F24](#/components/schemas/F24Metadata)
    
      #### 1.a. Richiesta presigned Url
      
      Invocare l'operazione [presignedUploadRequest](#/NewNotification/presignedUploadRequest) 
      con cui prenotare il caricamento. Possono essere effettuate un massimo di <span id="numberOfPresignedRequest">15</span> prenotazioni di caricamento
      per ogni richiesta.</br>
      In risposta si ottengono le seguenti informazioni:<br/>
      \- httpMethod <br/>
      \- secret <br/>
      \- url <br/>
      L'url restituito ha una validità di 1h.
      
      </br>

      #### 1.b Upload documenti della notifica
      
      Per ogni documento utilizzare un richiesta HTTP con metodo _httpMethod_ (POST o PUT) 
      all'url indicato dal campo _url_. <br/>
      In tale richiesta vanno aggiunti i seguenti header: <br/>
      \- _content-type_: valorizzato come il campo "contentType" della richiesta di cui al punto (1.a) <br/>
      \- _x-amz-meta-secret_: valorizzato con il valore del campo "secret" della risposta di cui al punto (1.a) <br/>
      \- _trailer_: valorizzato con ```x-amz-checksum-sha256``` <br/>
      \- _x-amz-checksum-sha256_: valorizzato con il checksum sha256, codificato in base 64, del contenuto binario del file che verrà caricato. (__N.B.__ questo è un trailer HTTP non un header).
        Vedi [HTTP Trailer](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Trailer) <br/>
        __NOTA:__ se l'operazione di upload è stata eseguita con successo, si otterrà come risposta _status 200 OK_. <br/>
        Nell'header di questa risposta, si otterrà il campo __x-amz-version-id__ che dovrà essere utilizzato durante <br/> 
        l'inserimento della notifica, nel campo ref.__versionToken__ in corrispondenza del documento ad esso associato.
  
     
      </br>
      </br>
      </br>
      
      #### 2. Richiesta di invio della notifica
    
      Per effettuare una richiesta di invio notifica, invocare l'operazione 
      [sendNewNotification](#/NewNotification/sendNewNotificationV21) utilizzando i riferimenti dei file 
      caricati ottenuti al punto (1.b).
      
      </br>
      </br>
      </br>

       <img src="https://raw.githubusercontent.com/pagopa/pn-delivery/e6f1db9eac9ace7fc2ad0fe6de241ab4525b6b6a/docs/openapi/images/verifica-accettazione-richiesta-invio.png" height="731" width="489" alt="Verifica accettazione richiesta" />
    </td>
      
    </tr>
    
    </table>
    
    
      ### 4. Monitorare l'avanzamento di una notifica
    
      Allo stesso modo del monitoraggio dell'accettazione della notifica da parte della Piattaforma sono 
      disponibili le due modalità.
      
      #### 4.1 Monitoraggio puntuale
    
      Se la "richiesta di invio di notifica" passa le validazioni viene trasformata in "notifica" e sarà 
      identificata dalla IUN restituito dall'operazione 
      [getNotificationRequestStatus](#/SenderReadB2B/getNotificationRequestStatusV21).</br> 
      A tal punto si potranno utilizzare l'operazione _GET /delivery/v2.1/notifications/sent/{iun}_ per 
      ottenere i dettagli della notifica, la _timeline_ che dettaglia il perfezionamento della
      notifica per il mittente e l'avanzamento delle comunicazioni nei confronti dei destinatari.
      
      #### 4.1 Monitoraggio tramite stream
    
      Questa modalità è consigliata in produzione. Per essere fruita è necessaria una operazione preliminare
      tramite la chiamata alla API [createEventStream](#/Streams/createEventStream)
      per configurare uno "stream" che registri il cambio di stato della notifica con il seguente payload di esempio:</br></br>``
      {
        "title": "NotificationAccepted",
        "eventType": "STATUS"
      }
      ``</br></br>che permette di monitorare gli eventi di tipo "STATO". Successivamente si può ottenere il dettaglio della stream appena creata chiamando la 
      API [getEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Streams/getEventStream), mentre si possono ottenere i dati degli eventi richiamando la API [consumeEventStream](https://petstore.swagger.io/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fpagopa%2Fpn-delivery-push%2Fdevelop%2Fdocs%2Fopenapi%2Fapi-external-b2b-webhook.yaml#/Events/consumeEventStream)
    
    
      ``</br></br>che permette di monitorare gli eventi di tipo "STATO". Successivamente si può ottenere il dettaglio 
      dello stream appena creato chiamando la API [getEventStream](#/Streams/getEventStream)), mentre si possono 
      ottenere i dati degli eventi richiamando la API [consumeEventStream](#/Streams/consumeEventStream)
  
  
      __NOTA__ saranno disponibili i dati di cambiamento di stato occorsi solo successivamente alla configurazione
      dello stream.

      </br>

      ### 5. Download dei Legal Facts

      E' possibile scaricare le Attestazioni Opponibili a Terzi e gli altri documenti conservati da Piattaforma Notifiche attraverso il servizio di [dowload Legal Fact](#/SenderReadB2B/getSentNotificationDocument) passando all'interno del path lo <strong>Iun</strong>, il <strong>legalFactType</strong> ed il <strong>legalFactId</strong>; si otterrà nella response un link che permette di scaricare il documento richiesto.</br> Per ottenere il <strong>legalFactType</strong> ed il <strong>legalFactId</strong> bisogna chiamare il servizio di [lettura dettaglio notifica](#/SenderReadB2B/getSentNotification) con lo <code>{Iun}</code> della notifica di interesse: all'interno del campo <i>timeline</i> della response è possibile trovare l'elenco degli eventi di quella notifica ed i <strong>legalFactType</strong> e <strong>legalFactId</strong> in corrispondenza degli eventi che generano documenti.
      
    </br>
    <h3>Le FAQ possono essere consultate al seguente link:
    <a href="https://docs.pagopa.it/v1.0-1/">https://docs.pagopa.it/v1.0-1/</a></h3>
    
    <details>
      <summary><strong><big><big><big><big>AMBIENTI</big></big></big></big></strong></summary>
    <ul>  
    <li><strong>https://api.notifichedigitali.it:</strong></br>Ambiente di produzione</li>
    <li><strong>https://api.uat.notifichedigitali.it:</strong></br>Ambiente di collaudo. Potrebbe subire modifiche/integrazioni in futuro, rimanendo comunque non-bloccante e rispettando il principio di retrocompatibilità</li>
    </ul>  
    </details></br>

  contact:
    email: pn-supporto-enti@pagopa.it
  license:
    name: Licenza di PN
    url: 'https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html'
servers:
  - url: https://api.notifichedigitali.it
    description: Ambiente di produzione
  - url: https://api.uat.notifichedigitali.it
    description: Ambiente di collaudo
tags:
  - name: HealthCheck
    description: >-
      Invocazioni per sapere lo stato di Piattaforma Notifiche # il servizio è ancora in fase di sviluppo
  - name: NewNotification
    description: >-
      Invocazioni per effettuare il pre-caricamento dei documenti della notifica e inviare notifiche
  - name: SenderReadB2B
    description: >-
      Invocazioni utilizzabili dai mittenti per verificare lo stato delle richieste 
      di notifica inviate e delle notifiche accettate.
  - name: NotificationPrice
    description: >-
      Invocazioni per determinare il costo della notifica per il destinatario.
  - name: LegalFacts
    description: >-
      Invocazioni per effettuare il download degli atti opponibili a terzi
  - name: PaymentEvents
    description: >-
      Invocazioni per comunicare eventi di pagamento dalla PA
  - name: NotificationCancellation
    description: >-
      Annullamento di una notifica

paths:
  ###########################################################################################
  ###                          STATUS PIATTAFORMA NOTIFICHE                               ###
  ###########################################################################################
  "/status":
    get:
      summary: status path
      description: status path per verificare lo stato di Piattaforma Notifiche
      tags:
        - HealthCheck
      operationId: status
      responses:
        '200':
          description: Ok
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/PnStatusResponse"
              example:
                functionalities: [NOTIFICATION_CREATE,NOTIFICATION_VISUALIZATION,NOTIFICATION_WORKFLOW]
                openIncidents: []
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/PnStatusResponse"
              example:
                functionalities: [NOTIFICATION_CREATE,NOTIFICATION_VISUALIZATION,NOTIFICATION_WORKFLOW]
                openIncidents:
                  - functionality: NOTIFICATION_CREATE
                    status: KO
                    startDate: "2019-08-24T14:15:22Z"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  ###########################################################################################
  ###                          GESTIONE PRECARICAMENTO ALLEGATI                           ###
  ###########################################################################################
  "/delivery/attachments/preload":
    post:
      summary: Richiesta di pre-caricamento dei documenti della notifica
      description: >-
        Operazione che richiede a Piattaforma Notifica le informazioni e le autorizzazioni necessarie 
        a precaricare uno o più file da allegare a una notifica. <br/>

        <details no-external>
        <summary><b> Attributi progettazione di alto livello </b></summary>
        | Proprietà                | Valore             |
        | -----------------------: | :----------------- |
        | __Intended usage__       | B2B, WEB           |
        | __Modalità interazione__ | Sincrona           |
        | __TPS (stimato)__        | 5 richieste/sec    |
        | __Idempotenza__          | No                 |
        | __Read/Write intensive__ | Write              |
        | __Cachable__             | No                 |
        </details>
      tags:
        - NewNotification
      operationId: presignedUploadRequest
      parameters: # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/PreLoadRequest"
              minItems: 1
              maxItems: 15
        required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PreLoadResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

    ###########################################################################################
    ###                          CREAZIONE RICHIESTE DI NOTIFICA                           ###
    ###########################################################################################

  "/delivery/v2.1/requests":
    post:
      summary: Richiesta invio notifica
      description: |-
        Operazione utilizzata dalla Pubblica Amministrazione per richiedere l'invio di una notifica.

        La restituzione di uno stato HTTP 202 significa solo che la richiesta è sintatticamente
        valida, non che la richiesta sia stata validata ed accettata. <br/>
        Per conoscere lo stato di accettazione della richiesta di notifica bisogna utilizzare l'operazione
        _getNotificationRequestStatus_ oppure utilizzare la modalità push prevista dai webhook. <br/>
        
        <details no-external>
        <summary><b> Attributi progettazione di alto livello </b></summary>
        | Proprietà                | Valore             |
        | -----------------------: | :----------------- |
        | __Intended usage__       | B2B, WEB           |
        | __Modalità interazione__ | Sincrona           |
        | __TPS (stimato)__        | 5 richieste/sec    |
        | __Idempotenza__          | No                 |
        | __Read/Write intensive__ | Write              |
        | __Cachable__             | No                 |
        </details>
      tags:
        - NewNotification
      operationId: sendNewNotificationV21
      parameters:                                                     # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'                # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'               # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/headerSourceChannel'         # NO EXTERNAL
        - $ref: '#/components/parameters/headerSourceChannelDetails'  # NO EXTERNAL
      requestBody:
        content:
          application/json:
            schema:
              $ref: "./schemas-pn-notification.yaml#/components/schemas/NewNotificationRequestV21"
        required: true
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationResponse"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '409':
          description: Conflict
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'


    ###########################################################################################
    ###                        VERIFICA STATO RICHIESTE DI NOTIFICA                         ###
    ###########################################################################################
    get:
      operationId: getNotificationRequestStatusV21                       # NO EXTERNAL
#      operationId: retrieveNotificationRequestStatusV21                 # ONLY EXTERNAL
      tags:
        - SenderReadB2B
      summary: Verifica accettazione richiesta notifica
      description: >-
        Questa operazione serve per verificare se la richiesta di notifica è stata accettata e ottenere
        lo IUN associato a tale richiesta. <br/>
        Bisogna specificare il parametro _requestId_ oppure la coppia costituita dai parametri 
        _paProtocolNumber_ e _idempotenceToken_. <br/>
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/notificationRequestId'
        - $ref: '#/components/parameters/paProtocolNumber'
        - $ref: '#/components/parameters/idempotenceToken'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewNotificationRequestStatusResponseV21"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'


    ###########################################################################################
    ###                             RICERCA NOTIFICHE ACCETTATE                             ###
    ###########################################################################################

  "/delivery/v2.1/notifications/sent/{iun}":
    get:
      summary: 'Mittente: lettura dettagli notifica versione 2'
      description: |-
        Questa operazione permette di leggere tutti i dettagli di una notifica accettata. <br/>

        <details no-external>
        <summary><b> Attributi progettazione di alto livello </b></summary>
        | Proprietà                | Valore             |
        | -----------------------: | :----------------- |
        | __Intended usage__       | B2B, WEB           |
        | __Modalità interazione__ | Sincrona           |
        | __TPS (stimato)__        |                    |
        | __Idempotenza__          | Si                 |
        | __Read/Write intensive__ | Read               |
        | __Cachable__             | No                 |
        </details>
      tags:
        - SenderReadB2B
      operationId: getSentNotificationV21                                      # NO EXTERNAL
#      operationId: retrieveSentNotificationV21                                # ONLY EXTERNAL
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'       # NO EXTERNAL
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
      responses:
        '200':
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/FullSentNotificationV21"
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

    ###########################################################################################
    ###                     DOWNLOAD DOCUMENTI E ALLEGATI PER PAGAMENTO                     ###
    ###########################################################################################

  "/delivery/notifications/sent/{iun}/attachments/documents/{docIdx}":
    get:
      description: |-
        Download documento notificato

        <details no-external>
        <summary><b> Attributi progettazione di alto livello </b></summary>
        | Proprietà                | Valore             |
        | -----------------------: | :----------------- |
        | __Intended usage__       | B2B, WEB           |
        | __Modalità interazione__ | Sincrona           |
        | __TPS (stimato)__        |                    |
        | __Idempotenza__          | Si                 |
        | __Read/Write intensive__ | Read               |
        | __Cachable__             | No                 |
        </details>
      summary: Download documento notificato
      tags:
        - SenderReadB2B
      operationId: getSentNotificationDocument                                      # NO EXTERNAL
#      operationId: retrieveSentNotificationDocument                                # ONLY EXTERNAL
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'        # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'      # NO EXTERNAL
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathDocumentIdx'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  "/delivery/notifications/sent/{iun}/attachments/payment/{recipientIdx}/{attachmentName}":
    get:
      description: Download allegato per pagamento
      summary: Download allegato per pagamento
      tags:
        - SenderReadB2B
      operationId: getSentNotificationAttachment                                      # NO EXTERNAL
#      operationId: retrieveSentNotificationAttachment                                # ONLY EXTERNAL
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'              # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'           # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'         # NO EXTERNAL
        - $ref: './parameters-notification-search.yaml#/components/parameters/pathIun'
        - $ref: '#/components/parameters/pathRecipientIdx'
        - $ref: '#/components/parameters/pathAttachmentName'
        - $ref: '#/components/parameters/attachmentIdx'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: './schemas-pn-notification.yaml#/components/schemas/NotificationAttachmentDownloadMetadataResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'


  '/delivery/price/{paTaxId}/{noticeCode}':                                         # ONLY EXTERNAL
    get:                                                                            # ONLY EXTERNAL
      operationId: getNotificationPrice                                             # NO EXTERNAL
#      operationId: retrieveNotificationPrice                                       # ONLY EXTERNAL
      summary: Retrieve notification price and effective date                       # ONLY EXTERNAL
      description: >-                                                               # ONLY EXTERNAL
        Usata dalla PA per recuperare il costo di notificazione tramite
         l'identificativo della posizione debitoria paTaxId e noticeCode.
      tags:                                                                         # ONLY EXTERNAL
        - NotificationPrice                                                         # ONLY EXTERNAL
      parameters:                                                                   # ONLY EXTERNAL
        - name: paTaxId                                                             # ONLY EXTERNAL
          description: Payment PA fiscal code                                       # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '77777777777'                                                    # ONLY EXTERNAL
          schema:                                                                   # ONLY EXTERNAL
            $ref: 'schemas-pn-notification.yaml#/components/schemas/paTaxId'        # ONLY EXTERNAL
        - name: noticeCode                                                          # ONLY EXTERNAL
          description: Payment notice number  numero avviso                         # ONLY EXTERNAL
          in: path                                                                  # ONLY EXTERNAL
          required: true                                                            # ONLY EXTERNAL
          example: '302000100000019421'                                             # ONLY EXTERNAL
          schema:                                                                   # ONLY EXTERNAL
            $ref: 'schemas-pn-notification.yaml#/components/schemas/noticeCode'     # ONLY EXTERNAL
      responses:                                                                    # ONLY EXTERNAL
        '200':                                                                      # ONLY EXTERNAL
          description: OK                                                           # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/json:                                                       # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/NotificationPriceResponse'              # ONLY EXTERNAL
        '400':                                                                      # ONLY EXTERNAL
          description: Invalid input                                                # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '404':                                                                      # ONLY EXTERNAL
          description: Not Found                                                    # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL
        '500':                                                                      # ONLY EXTERNAL
          description: Internal Server Error                                        # ONLY EXTERNAL
          content:                                                                  # ONLY EXTERNAL
            application/problem+json:                                               # ONLY EXTERNAL
              schema:                                                               # ONLY EXTERNAL
                $ref: '#/components/schemas/Problem'                                # ONLY EXTERNAL

    ###########################################################################################
    ###                     RICEZIONE DATI AVVENUTO PAGAMENTO DALLA PA                      ###
    ###########################################################################################
  '/delivery/events/payment/pagopa':
    post:
      operationId: paymentEventsRequestPagoPa
      parameters:                                                  # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'        # NO EXTERNAL
      description: >-
        Questa API è a disposizione della Pubblica Amministrazione per inviare eventi
        di chiusura di una o più posizioni debitorie di tipo PagoPA. <br/>
      tags:
        - PaymentEvents
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/PaymentEventsRequestPagoPa"
      responses:
        '204':
          description: OK
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  '/delivery/events/payment/f24':
    post:
      deprecated: true
      operationId: paymentEventsRequestF24
      parameters:                                                  # NO EXTERNAL
        - $ref: '#/components/parameters/uidAuthFleet'             # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'            # NO EXTERNAL
        - $ref: '#/components/parameters/cxGroupsAuthFleet'        # NO EXTERNAL
      description: >-
        Questa API è a disposizione della Pubblica Amministrazione per inviare eventi
        di chiusura di una o più posizioni debitorie di tipo F24. <br/>
      tags:
        - PaymentEvents
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/PaymentEventsRequestF24"
      responses:
        '204':
          description: OK
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

components:

  parameters:
    ############################################################################################
    ###                     PARAMETRO SORGENTE CREAZIONE NOTIFICA                            ###
    ############################################################################################
    headerSourceChannel:                                                            # NO EXTERNAL
      name: x-pagopa-pn-src-ch                                                      # NO EXTERNAL
      in: header                                                                    # NO EXTERNAL
      description: Notification creation source channel                             # NO EXTERNAL
      required: true                                                                # NO EXTERNAL
      schema:                                                                       # NO EXTERNAL
        type: string                                                                # NO EXTERNAL
        maxLength: 3                                                                # NO EXTERNAL
        pattern: "B2B|WEB"                                                          # NO EXTERNAL

    headerSourceChannelDetails:                                                     # NO EXTERNAL
      name: x-pagopa-pn-src-ch-details                                              # NO EXTERNAL
      in: header                                                                    # NO EXTERNAL
      description: Notification creation source channel details                     # NO EXTERNAL
      required: false                                                               # NO EXTERNAL
      schema:                                                                       # NO EXTERNAL
        type: string                                                                # NO EXTERNAL

    ############################################################################################
    ###                     PARAMETRI DI AUTENTICAZIONE E AUTORIZZAZIONE                     ###
    ############################################################################################
    cxTypeAuthFleet:                                                                # NO EXTERNAL
      $ref: './remote-refs.yaml#/components/parameters/cxTypeAuthFleet'             # NO EXTERNAL
    cxIdAuthFleet:                                                                  # NO EXTERNAL
      $ref: './remote-refs.yaml#/components/parameters/cxIdAuthFleet'               # NO EXTERNAL
    cxGroupsAuthFleet:                                                              # NO EXTERNAL
      $ref: './remote-refs.yaml#/components/parameters/cxGroupsAuthFleet'           # NO EXTERNAL
    uidAuthFleet:                                                                   # NO EXTERNAL
      $ref: './remote-refs.yaml#/components/parameters/uidAuthFleet'                # NO EXTERNAL

    ############################################################################################
    ###                       PARAMETRI RICERCA RICHIESTA DI NOTIFICA                        ###
    ############################################################################################
    notificationRequestId:
      in: query
      required: false
      name: notificationRequestId
      description: identificativo della richiesta di notifica
      schema:
        type: string
        maxLength: 36
        pattern: ^[A-Za-z0-9+/=]{36}$
    paProtocolNumber:
      name: paProtocolNumber
      in: query
      required: false
      description: >-
        Numero di protocollo associato alla notifica, può essere riutilizzato per rettifiche.
      schema:
        type: string
        # wide range of characters
        pattern: ^.*$
        maxLength: 256
    idempotenceToken:
      name: idempotenceToken
      description: >-
        token usato per disambiguare "richieste di notificazione" effettuate con lo stesso 
        numero di protocollo.
      in: query
      required: false
      schema:
        type: string
        # ASCII printable characters
        pattern: ^[ -~]*$
        maxLength: 256


    ############################################################################################
    ###                             PARAMETRI DOWNLOAD DOCUMENTI                             ###
    ############################################################################################
    pathDocumentIdx:
      name: docIdx
      description: indice del documento nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathRecipientIdx:
      name: recipientIdx
      description: indice del destinatario nella lista partendo da 0.
      in: path
      required: true
      schema:
        type: integer
        format: int32
    pathAttachmentName:
      name: attachmentName
      description: Tipologia del pagamento allegato alla notifica. Valori possibili PAGOPA|F24
      in: path
      required: true
      schema:
        type: string
        minLength: 3
        maxLength: 6
        pattern: "PAGOPA|F24"
    attachmentIdx:
      in: query
      name: attachmentIdx
      description: indice del documento di pagamento partendo da 0
      required: false
      schema:
        type: integer
        format: int32
    ############################################################################################
    ###                      PARAMETRI DOWNLOAD ATTI OPPONIBILI A TERZI                      ###
    ############################################################################################
    pathLegalFactType:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactType'
    pathLegalFactId:
      $ref: './remote-refs.yaml#/components/parameters/pathLegalFactId'


  schemas:
    ###########################################################################################
    ###                             DTO STATUS PN                                           ###
    ###########################################################################################
    PnStatusResponse:
      $ref: './remote-refs.yaml#/components/schemas/PnStatusResponse'

    ###########################################################################################
    ###                             DTO PRECARICAMENTO ALLEGATI                             ###
    ###########################################################################################
    PreLoadRequest:
      title: Richiesta di precaricamento di un File
      type: object
      required:
        - sha256
      properties:
        preloadIdx:
          title: Id della richiesta di precaricamento di un file
          description: >-
            Identificativo univoco all'interno della request HTTP, serve per correlare la risposta.
            Stringa alfanumerica con caratteri utilizzabili in un nome file.
          type: string
          minLength: 1
          maxLength: 512
          pattern: ^[a-zA-Z0-9._-]{1,512}$
        contentType:
          title: MIME type del file che verrà caricato
          description: >-
            Il MIME type dell'allegato che dovrà essere caricato. Attualmente sono supportati
              - application/pdf
              - application/json
          type: string
          minLength: 15
          maxLength: 16
          pattern: ^application\/(pdf|json)$
        sha256:
          title: checksum sha256 del file che verrà caricato
          description: >-
            checksum sha256, codificato in base 64, del contenuto binario del file che verrà
            caricato
          type: string
          example: 'jezIVxlG1M1woCSUngM6KipUN3/p8cG5RMIPnuEanlE='
          minLength: 44
          maxLength: 44
          pattern: ^[A-Za-z0-9+\/]{43}=|[A-Za-z0-9+\/]{44}$

    PreLoadResponse:
      title: Informazioni per il caricamento file
      description: >-
        Per ogni richiesta che è stata fatta viene fornito un presigned URL e le 
        informazioni per usarlo.
      type: object
      properties:
        preloadIdx:
          description: per correlazione con la richiesta. Stringa alfanumerica con caratteri utilizzabili in un file.
          type: string
          minLength: 1
          maxLength: 512
          pattern: ^[a-zA-Z0-9._-]{1,512}$
        secret:
          description: >-
            Token aggiuntivo per far si che sia necessario intercettare anche gli 
            header e non solo l'URL di upload del contenuto del documento.
          example: AZ23RF12
          type: string
        httpMethod:
          description: >-
            Indica se per l'upload del contenuto file bisogna utilizzare il metodo PUT o POST
          type: string
          example: PUT
          enum:
            - POST
            - PUT
        url:
          description: >-
            URL a cui effettuare l'upload del contenuto del documento.
          type: string
          example: 'https://preloadpn.aws.amazon.......'
        key:
          description: >-
            la chiave restituita sarà globalmente unica e andrà utilizzata nella richiesta 
            di notifica.
          example: 'PN_NOTIFICATION_ATTACHMENTS-0001-301W-B9CB-9U72-WIKD'
          type: string
    NotificationPriceResponse:
      title: Notification price Response
      description: >-
        Notification price and effective date
      type: object
      properties:
        iun:
          $ref: './schemas-pn-notification.yaml#/components/schemas/IUN'
        amount:
          description: amount in euro cents
          type: integer
          format: int32
        refinementDate:
          description: data di perfezionamento per decorrenza termini localizzata espressa alla mezzanotte del giorno in cui si verifica l'evento
          type: string
          format: date-time
        notificationViewDate:
          description: data di perfezionamento per presa visione espressa alla mezzanotte del giorno in cui si verifica l'evento
          type: string
          format: date-time

    ###########################################################################################
    ###                              DTO RICHIESTE DI NOTIFICA                              ###
    ###########################################################################################

    NewNotificationResponse:
      title: Identificativi della richiesta di notifica
      description: >-
        Contiene le informazioni per identificare una richiesta di invio notifica
        che non è ancora stata accettata da Piattaforma notifiche.
      type: object
      required:
        - notificationRequestId
        - paProtocolNumber
      properties:
        notificationRequestId:
          type: string
          description: >-
            identificativo univoco di una richiesta di invio notifica, non è lo IUN
          maxLength: 36
          pattern: ^[A-Za-z0-9+/=]{36}$
        paProtocolNumber:
          type: string
          description: Identificativo inviato dalla pubblica amministrazione
        idempotenceToken:
          description: >-
            Ripetizione del token usato per disambiguare "richieste di notificazione" 
            effettuate con lo stesso numero di protocollo (campo _paProtocolNumber_).
          type: string

    NewNotificationRequestStatusResponseV21:
      allOf:
        - $ref: "./schemas-pn-notification.yaml#/components/schemas/NewNotificationRequestV21"
        - type: object
          required:
            - notificationRequestId
            - notificationRequestStatus
          properties:
            notificationRequestId:
              description: >-
                identificativo univoco di una richiesta di invio notifica, non è lo IUN
              type: string
            notificationRequestStatus:
              description: >-
                - __WAITING__: in attesa di essere valutata
                - __ACCEPTED__: richiesta di notifica accettata, lo IUN è valorizzato
                - __REFUSED__: richiesta di notifica rifiutata, è valorizzato il campo _errors_
              type: string
            retryAfter:
              type: integer
              format: int32
              description: >-
                Numero di secondi da attendere prima di effettuare una nuova richiesta per 
                la stessa entità; valorizzato quando lo status è __WAITING__.
            iun:
              $ref: "./schemas-pn-notification.yaml#/components/schemas/IUN"
            errors:
              description: >-
                Elenco degli errori che hanno causato il rifiuto della richiesta di notifica
              type: array
              items:
                $ref: '#/components/schemas/ProblemError'

    Problem:
      $ref: './remote-refs.yaml#/components/schemas/Problem'
    ProblemError:
      $ref: './remote-refs.yaml#/components/schemas/ProblemError'


    ###########################################################################################
    ###                              DTO NOTIFICA CON DETTAGLI                              ###
    ###########################################################################################

    FullSentNotificationV21:
      description: >-
        Le informazioni riguardanti una notifica (richiesta di notifica accettata) e il 
        processo di inoltro della notifica verso il cittadino.
      allOf:
        - $ref: './schemas-pn-notification.yaml#/components/schemas/SentNotificationV21'
        - type: object
          required:
            - notificationStatus
            - notificationStatusHistory
            - timeline
          properties:
            notificationStatus:
              $ref: '#/components/schemas/NotificationStatus'
            notificationStatusHistory:
              $ref: '#/components/schemas/NotificationStatusHistory'
            timeline:
              description: >-
                elenco dettagliato di tutto ciò che è accaduto durrante il processo di notifica
              type: array
              items:
                $ref: '#/components/schemas/TimelineElementV20'
            recipientIds:                                                               # NO EXTERNAL
              description: Lista degli identificativi anonimizzati dei destinatari      # NO EXTERNAL
              type: array                                                               # NO EXTERNAL
              items:                                                                    # NO EXTERNAL
                type: string                                                            # NO EXTERNAL
            sourceChannel:                                                              # NO EXTERNAL
              type: string                                                              # NO EXTERNAL
              description: Canale sorgente della richiesta di notifica                  # NO EXTERNAL
            sourceChannelDetails:                                                       # NO EXTERNAL
              type: string                                                              # NO EXTERNAL
              description: Dettagli del canale sorgente della richiesta di notifica     # NO EXTERNAL

    ###########################################################################################
    ###                              DTO EVENTO DI PAGAMENTO                                ###
    ###########################################################################################

    PaymentEventsRequestPagoPa:
      title: Invio eventi di pagamento da PA a PN
      description: >- 
        Richiesta contenente un array di eventi di pagamento di tipo PagoPA di cui una Pubblica Amministrazione
        deve avvisare Piattaforma Notifiche.
      type: object
      required:
        - events
      properties:
        events:
          description: Elenco degli eventi di pagamento
          type: array
          items:
            $ref: '#/components/schemas/PaymentEventPagoPa'

    PaymentEventsRequestF24:
      title: Invio eventi di pagamento da PA a PN
      description: >- 
        Richiesta contenente un array di eventi di pagamento di tipo F24 di cui una Pubblica Amministrazione
        deve avvisare Piattaforma Notifiche.
      type: object
      required:
        - events
      properties:
        events:
          description: Elenco degli eventi di pagamento
          type: array
          items:
            $ref: '#/components/schemas/PaymentEventF24'

    #PaymentEvents:
    #  type: object
    #  oneOf:
    #    - $ref: '#/components/schemas/PaymentEventPagoPa'
    #    - $ref: '#/components/schemas/PaymentEventF24'

    PaymentEventPagoPa:
      title: Evento di pagamento PagoPa
      description: >-
        Comprende: <br/>
          - _noticeCode_: "codice avviso pagoPA" di pagamento del sistema pagoPA, usato per pagamento online.<br/>
          - _creditorTaxId_: codice fiscale dell'ente a cui fa riferimento il "codice avviso pagoPA". <br/>
          - data e ora del pagamento. <br/>
          - importo del pagamento in eurocent. <br/>
      type: object
      required:
        - noticeCode
        - creditorTaxId
        - paymentDate
        - amount
      properties:
        noticeCode:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/noticeCode'
        creditorTaxId:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/paTaxId'
        paymentDate:
          type: string
          pattern: ^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(\.[0-9]+)?(Z|([+\-][0-9]{2}):([0-9]{2}))$
          description: data e ora in formato ISO 8601
        amount:
          type: integer
          format: int32

    PaymentEventF24:
      title: Evento di pagamento F24
      description: >-
        Comprende: <br/>
          - lo _IUN_ della notifica pagata, <br/>
          - data e ora del pagamento, <br/>
          - il codice fiscale del destinatario pagatore, <br/>
          - la tipologia del destinatario pagatore (PF / PG), <br/>
          - importo del pagamento in eurocent. <br/>
      type: object
      required:
        - iun
        - paymentDate
        - recipientTaxId
        - recipientType
        - amount
      properties:
        iun:
          type: string
          minLength: 25
          maxLength: 25
          pattern: ^[A-Z]{4}-[A-Z]{4}-[A-Z]{4}-[0-9]{6}-[A-Z]{1}-[0-9]{1}$
        paymentDate:
          type: string
          format: date-time
        recipientTaxId:
          $ref: 'schemas-pn-notification.yaml#/components/schemas/TaxId'
        recipientType:
          type: string
          minLength: 2
          maxLength: 2
          pattern: "PF|PG"
        amount:
          type: integer
          format: int32

    TimelineElementV20:
      $ref: './remote-refs.yaml#/components/schemas/TimelineElementV20'
    NotificationStatus:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatus'
    NotificationStatusHistory:
      $ref: './remote-refs.yaml#/components/schemas/NotificationStatusHistory'
    LegalFactDownloadMetadataResponse:
      $ref: './remote-refs.yaml#/components/schemas/LegalFactDownloadMetadataResponse'
    F24Metadata:
      $ref: './remote-refs.yaml#/components/schemas/F24Metadata'
    RequestStatus:
      $ref: './remote-refs.yaml#/components/schemas/RequestStatus'

#  securitySchemes:        # ONLY EXTERNAL
#    ApiKeyAuth:           # ONLY EXTERNAL
#      type: apiKey        # ONLY EXTERNAL
#      in: header          # ONLY EXTERNAL
#      name: x-api-key     # ONLY EXTERNAL

#security:                 # ONLY EXTERNAL
#  - ApiKeyAuth: [] # use the same name as under securitySchemes    # ONLY EXTERNAL




